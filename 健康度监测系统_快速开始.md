# å¥åº·åº¦ç›‘æµ‹ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ¯ ç›®çš„
è¯Šæ–­æ‚¨é‡åˆ°çš„é—®é¢˜ï¼šè®¾å¤‡è¿è¡Œå‡ å¤©ååˆ·å¡æ— å“åº”ï¼Œéœ€è¦æ–­ç”µé‡å¯æ‰èƒ½æ¢å¤ã€‚

## ğŸ“‹ Supabase æ•°æ®åº“è¡¨åˆ›å»º

åœ¨Supabase SQL Editorä¸­æ‰§è¡Œä»¥ä¸‹SQLï¼š

```sql
-- ç³»ç»Ÿå¥åº·åº¦æ—¥å¿—è¡¨
CREATE TABLE system_health_logs (
  id BIGSERIAL PRIMARY KEY,
  device_id VARCHAR(50) NOT NULL,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- ç³»ç»Ÿè¿è¡Œæ—¶é—´
  uptime_seconds BIGINT,
  uptime_hours DECIMAL(10,2),

  -- å†…å­˜çŠ¶æ€
  free_heap BIGINT,
  min_free_heap BIGINT,
  heap_usage_percent DECIMAL(5,2),

  -- WiFi çŠ¶æ€
  wifi_connected BOOLEAN,
  wifi_rssi INTEGER,
  wifi_reconnect_count INTEGER,

  -- NFC æ¨¡å—çŠ¶æ€ï¼ˆé‡ç‚¹å…³æ³¨ï¼‰
  nfc_initialized BOOLEAN,
  nfc_firmware_version VARCHAR(10),
  nfc_last_read_success BOOLEAN,
  nfc_read_success_count INTEGER,
  nfc_read_fail_count INTEGER,
  nfc_success_rate DECIMAL(5,2),
  nfc_idle_minutes INTEGER,

  -- I2C/OLED çŠ¶æ€
  oled_working BOOLEAN,
  i2c_error_count INTEGER,

  -- ä¸šåŠ¡ç»Ÿè®¡
  total_transactions INTEGER,
  transactions_last_hour INTEGER,

  -- ç³»ç»ŸçŠ¶æ€
  current_state VARCHAR(30),
  loop_execution_time_ms INTEGER,
  watchdog_reset_count INTEGER,

  -- é”™è¯¯/å¼‚å¸¸
  last_error TEXT,
  error_count_last_30min INTEGER
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_health_device_time ON system_health_logs(device_id, timestamp DESC);
CREATE INDEX idx_health_timestamp ON system_health_logs(timestamp DESC);
CREATE INDEX idx_health_nfc_status ON system_health_logs(nfc_initialized, nfc_success_rate);
```

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. åˆ›å»ºæ•°æ®åº“è¡¨
æŒ‰ä¸Šé¢çš„SQLåœ¨Supabaseä¸­åˆ›å»ºè¡¨

### 2. ç¼–è¯‘ä¸Šä¼ ä»£ç 
ä»£ç å·²é›†æˆï¼Œç›´æ¥ç¼–è¯‘ä¸Šä¼ åˆ°ESP32

### 3. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
è®¾å¤‡å¯åŠ¨å3ç§’ï¼Œä¼šä¸Šä¼ **åˆå§‹åŒ–åŸºçº¿æ—¥å¿—**

ä¸²å£è¾“å‡ºï¼š
```
âœ… åˆå§‹åŒ–æ—¥å¿—ä¸Šä¼ æˆåŠŸ
```

åœ¨SupabaseæŸ¥è¯¢ï¼š
```sql
SELECT * FROM system_health_logs
WHERE device_id = 'æ‚¨çš„è®¾å¤‡MAC'
ORDER BY timestamp ASC
LIMIT 1;
```

### 4. ç­‰å¾…è¿è¡Œæ•°æ®
- æ¯30åˆ†é’Ÿè‡ªåŠ¨ä¸Šä¼ ä¸€æ¬¡
- è®©è®¾å¤‡è¿è¡Œ2-3å¤©
- è§‚å¯Ÿåˆ·å¡æ˜¯å¦å‡ºç°æ— å“åº”é—®é¢˜

### 5. åˆ†æé—®é¢˜

å½“åˆ·å¡æ— å“åº”æ—¶ï¼Œæ‰§è¡Œæ­¤æŸ¥è¯¢å¯¹æ¯”åˆå§‹çŠ¶æ€å’Œå½“å‰çŠ¶æ€ï¼š

```sql
WITH baseline AS (
  SELECT * FROM system_health_logs
  WHERE device_id = 'æ‚¨çš„è®¾å¤‡MAC'
  ORDER BY timestamp ASC
  LIMIT 1
),
latest AS (
  SELECT * FROM system_health_logs
  WHERE device_id = 'æ‚¨çš„è®¾å¤‡MAC'
  ORDER BY timestamp DESC
  LIMIT 1
)
SELECT
  'åˆå§‹çŠ¶æ€' as status,
  baseline.uptime_hours,
  baseline.free_heap / 1024 as free_kb,
  baseline.nfc_initialized,
  baseline.nfc_success_rate,
  baseline.nfc_idle_minutes,
  baseline.total_transactions
FROM baseline
UNION ALL
SELECT
  'å½“å‰çŠ¶æ€' as status,
  latest.uptime_hours,
  latest.free_heap / 1024 as free_kb,
  latest.nfc_initialized,
  latest.nfc_success_rate,
  latest.nfc_idle_minutes,
  latest.total_transactions
FROM latest;
```

## ğŸ” å…³é”®é—®é¢˜æŒ‡æ ‡

### âš ï¸ NFCç©ºé—²æ—¶é—´ï¼ˆnfc_idle_minutesï¼‰
- **æ­£å¸¸**ï¼š< 60åˆ†é’Ÿ
- **å¼‚å¸¸**ï¼š> 120åˆ†é’Ÿ â†’ NFCå¯èƒ½æŒ‚æ­»

### âš ï¸ NFCæˆåŠŸç‡ï¼ˆnfc_success_rateï¼‰
- **æ­£å¸¸**ï¼š> 95%
- **å¼‚å¸¸**ï¼š< 80% â†’ NFCé€šä¿¡å¼‚å¸¸

### âš ï¸ å‰©ä½™å†…å­˜ï¼ˆfree_heapï¼‰
- **æ­£å¸¸**ï¼š> 200KB
- **å±é™©**ï¼š< 50KB â†’ å†…å­˜æ³„æ¼

### âš ï¸ NFCåˆå§‹åŒ–çŠ¶æ€ï¼ˆnfc_initializedï¼‰
- **æ­£å¸¸**ï¼štrue
- **å¼‚å¸¸**ï¼šfalse â†’ NFCæ¨¡å—å¤±è”

## ğŸ› ï¸ ä¸²å£è°ƒè¯•å‘½ä»¤

æ‰“å¼€ä¸²å£ç›‘è§†å™¨ï¼ˆ115200æ³¢ç‰¹ç‡ï¼‰ï¼š

```
health          - æŸ¥çœ‹å½“å‰å¥åº·åº¦çŠ¶æ€
health upload   - ç«‹å³ä¸Šä¼ å¥åº·åº¦æ—¥å¿—
help            - æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
```

## ğŸ“Š å…¸å‹é—®é¢˜æ¨¡å¼

### æ¨¡å¼1ï¼šå†…å­˜æ³„æ¼
- **ç—‡çŠ¶**ï¼šfree_heapä» 298KB æŒç»­ä¸‹é™åˆ° < 50KB
- **åŸå› **ï¼šå†…å­˜æ³„æ¼
- **ç»“æœ**ï¼šç³»ç»Ÿç¼“æ…¢æˆ–å¡æ­»

### æ¨¡å¼2ï¼šNFCæŒ‚æ­»
- **ç—‡çŠ¶**ï¼šnfc_idle_minutes > 120, nfc_initialized = false
- **åŸå› **ï¼šNFCæ¨¡å—æŒ‚æ­»
- **ç»“æœ**ï¼šåˆ·å¡å®Œå…¨æ— å“åº”

### æ¨¡å¼3ï¼šI2Cå†²çª
- **ç—‡çŠ¶**ï¼ši2c_error_count æŒç»­å¢åŠ 
- **åŸå› **ï¼šI2Cæ€»çº¿å†²çª
- **ç»“æœ**ï¼šåˆ·å¡æ—¶å¥½æ—¶å

### æ¨¡å¼4ï¼šWiFiå½±å“
- **ç—‡çŠ¶**ï¼šwifi_reconnect_count é¢‘ç¹å¢åŠ 
- **åŸå› **ï¼šWiFié‡è¿é˜»å¡ä¸»å¾ªç¯
- **ç»“æœ**ï¼šå“åº”å»¶è¿Ÿ

## ğŸ“– è¯¦ç»†æ–‡æ¡£

å®Œæ•´è¯´æ˜è¯·å‚è€ƒï¼š`HEALTH_MONITOR_README.md`

---

**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2025-12-04
**ä½œè€…**: GoldSky Development Team
