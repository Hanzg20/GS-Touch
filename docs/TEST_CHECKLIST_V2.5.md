# GoldSky_Lite v2.5 测试检查清单

版本: v2.5 Enhanced Security & Reliability
测试日期: __________
测试人员: __________

---

## 📋 上传前检查

- [ ] Arduino IDE编译无错误
- [ ] 确认ESP32-S3开发板选择正确
- [ ] 串口波特率设置为115200
- [ ] 上传分区方案选择 "Default 4MB with spiffs"

---

## 🔧 基础功能测试

### 1. 系统启动
- [ ] 上电后LED自检正常(4个LED依次点亮)
- [ ] 串口输出启动信息
- [ ] 显示 "⚙️ 首次启动,保存默认配置..." (首次上传)
- [ ] 显示 "✅ 配置已加载" (后续启动)
- [ ] OLED显示欢迎界面

**预期串口输出**:
```
🚗 Eaglson Coin Wash Terminal v2.5
Fixed Edition - 模块化重构版 + 安全配置
🎯 5步流程 + 4LED + VIP查询 + 离线队列
=======================================
💾 初始化NVS存储...
⚙️ 首次启动,保存默认配置...
✅ 配置已加载:
   WiFi SSID: hanzg_hanyh
   Machine ID: EAGLESON_TERMINAL_01
📥 加载了 0 笔离线交易
```

### 2. WiFi连接
- [ ] WiFi自动连接成功
- [ ] NETWORK LED常亮
- [ ] 串口显示IP地址

### 3. NFC读卡
- [ ] 刷卡后蜂鸣器响
- [ ] 串口显示 "读取到卡片: HEX=xxx, DEC=xxx"
- [ ] OLED显示卡号和余额

---

## ⭐ 新功能测试 (v2.5)

### 测试1: 离线交易队列

#### 步骤:
1. **在线交易** (建立基准)
   - [ ] WiFi已连接
   - [ ] 刷卡选择套餐
   - [ ] 交易成功
   - [ ] 串口显示 "✅ 成功后尝试同步离线队列"

2. **离线交易** (断网测试)
   - [ ] 关闭WiFi路由器或修改SSID
   - [ ] 等待30秒,NETWORK LED慢闪
   - [ ] 刷卡3次完成交易
   - [ ] 每次串口显示 "✅ 交易已缓存到离线队列 (1/50)"
   - [ ] 数字递增: (2/50), (3/50)

3. **自动同步** (恢复网络)
   - [ ] 恢复WiFi连接
   - [ ] NETWORK LED恢复常亮
   - [ ] 再次刷卡完成1笔在线交易
   - [ ] 串口显示 "🔄 同步离线交易队列 (3 笔)..."
   - [ ] 串口显示 "✅ 成功同步 3 笔离线交易"

4. **数据验证**
   - [ ] 登录Supabase查看 `jc_transaction_history` 表
   - [ ] 确认存在4笔交易(1笔在线 + 3笔离线同步)

#### 预期串口输出:
```
// 离线模式
[INFO] ⚠️ WiFi断开，尝试重连...
[INFO] ⚠️ WiFi重连失败，继续离线模式
[INFO] ✅ 在线验证成功
[INFO] 🔄 离线模式：余额更新已缓存
[INFO] ✅ 交易已缓存到离线队列 (1/50)

// 恢复后
[INFO] ✅ WiFi恢复成功: 192.168.x.x
[INFO] 🔄 同步离线交易队列 (3 笔)...
[INFO] ✅ 成功同步 3 笔离线交易
```

---

### 测试2: 断电保护

#### 步骤:
1. **创建离线交易**
   - [ ] 断开WiFi
   - [ ] 刷卡2次
   - [ ] 串口显示缓存2笔交易

2. **断电重启**
   - [ ] 立即拔掉USB电源(不等WiFi恢复)
   - [ ] 重新上电

3. **验证恢复**
   - [ ] 启动串口显示 "📥 加载了 2 笔离线交易"
   - [ ] WiFi连接后自动同步
   - [ ] 串口显示 "✅ 成功同步 2 笔离线交易"

---

### 测试3: API输入验证

#### 步骤:
使用未注册的卡片刷卡:
- [ ] 串口显示 "❌ API返回空数据" 或 "Invalid Card"
- [ ] 系统不崩溃,正常返回欢迎界面

---

### 测试4: 配置持久化

#### 步骤:
1. **首次上传**
   - [ ] 串口显示 "⚠️ 首次启动,保存默认配置..."

2. **重启验证**
   - [ ] 按复位按钮或重新上电
   - [ ] 串口显示 "✅ 配置已加载"
   - [ ] WiFi自动连接(无需重新输入)

---

## 🛠️ 压力测试

### 队列容量测试
- [ ] 断开WiFi
- [ ] 连续刷卡10次
- [ ] 串口显示队列计数正确 (1/50) → (10/50)
- [ ] 恢复WiFi后全部同步

### 长时间运行
- [ ] 运行24小时
- [ ] 定期检查串口日志
- [ ] 无内存泄漏(剩余内存稳定)
- [ ] 无自动重启

---

## ❌ 常见问题排查

### WiFi不连接
- [ ] 检查SSID和密码是否正确
- [ ] 检查路由器2.4GHz信号
- [ ] 串口显示具体错误信息

### NFC不读卡
- [ ] 检查接线(MOSI/MISO/SCK/CS/RST)
- [ ] 串口显示 "NFC版本: 0x92" (正常)
- [ ] 卡片距离天线<3cm

### 编译错误
- [ ] 检查是否安装 `ArduinoJson` 库
- [ ] 检查是否选择正确的开发板
- [ ] 清空缓存重新编译

### 离线队列未同步
- [ ] 检查WiFi是否真正恢复
- [ ] 检查API密钥是否正确
- [ ] 手动重启设备触发同步

---

## ✅ 测试通过标准

全部以下项必须通过:
- [x] 基础功能正常(WiFi/NFC/显示)
- [x] 离线交易正确缓存
- [x] WiFi恢复后自动同步
- [x] 断电后数据不丢失
- [x] API验证正常工作
- [x] 运行24小时无崩溃

---

## 📝 测试记录

### 发现的问题
1. ______________________________
2. ______________________________
3. ______________________________

### 测试结果
- 测试日期: __________
- 通过/失败: __________
- 备注: __________

---

**测试人员签名**: __________
**日期**: __________
