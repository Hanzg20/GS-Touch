# Nayax配置适配 - 修改总结

根据Nayax Pulse/ccTalk配置，已完成以下修改：

---

## ✅ 修改内容

### 1. 脉冲时序参数修正 ⚠️ **重要**

**文件**: [config.h](config.h) (第57-60行)

```cpp
// 修改前 ❌
#define PULSE_WIDTH_MS 100        // 10%占空比，太短！
#define PULSE_INTERVAL_MS 1000

// 修改后 ✅
#define PULSE_WIDTH_MS 500        // 50%占空比，匹配Nayax标准
#define PULSE_INTERVAL_MS 1000    // 高电平500ms + 低电平500ms = 1秒
```

**影响**：
- ✅ 符合ccTalk行业标准
- ✅ 提高洗车设备识别可靠性
- ✅ 匹配Nayax的"Pulse active time = 50 × 10ms"

---

### 2. 套餐配置匹配Nayax

**文件**: [config.h](config.h) (第121-132行)

| 套餐 | 修改前 | 修改后（Nayax标准） |
|------|--------|-------------------|
| 套餐1 | 4分钟/4脉冲/$4 ✅ | 4分钟/4脉冲/$4 |
| 套餐2 | 6分钟/8脉冲/$6 ❌ | **5分钟/5脉冲/$5** |
| 套餐3 | 8分钟/9脉冲/$9 ❌ | **8分钟/8脉冲/$8** |
| 套餐4 | 10分钟/12脉冲/$12 ❌ | **15分钟/15脉冲/$15** |

**关键修正**：
```cpp
// 修改后配置
static Package PACKAGES[PACKAGE_COUNT] = {
  {"4 Min Wash", "4分钟洗车", 4, 4.00, 4, false},
  {"5 Min Wash", "5分钟洗车", 5, 5.00, 5, false},     // ← 修改
  {"8 Min Wash", "8分钟洗车", 8, 8.00, 8, false},     // ← 修改
  {"15 Min Wash", "15分钟洗车", 15, 15.00, 15, false}, // ← 修改
  {"VIP Info", "VIP查询", 0, 0.00, 0, true}
};
```

**重要原则**：
- ✅ **时长 = 脉冲数**（每个脉冲代表1分钟）
- ✅ **价格 = 时长 × $1.00**（线性定价）
- ✅ **标题格式**："X Min Wash"（明确显示时长）

---

## 📊 Nayax配置参考

从您提供的Nayax截图中提取的标准配置：

```
Pulse active time:   50 × 10ms = 500ms
Pulse inactive time: 50 × 10ms = 500ms
Pulse Increment:     4, 5, 8, 15 (脉冲数)
Pulse Prices:        400, 500, 800, 1500 (分，即$4, $5, $8, $15)
Pulse Titles:        "4 Min", "5 Min", "8 Min", "15 Min"
```

---

## ⚠️ 测试要点

上传新配置后，请测试：

### 1. 脉冲时序验证

如果有示波器，测量GPIO 3（PULSE_OUT）：
- [ ] 高电平持续 **500ms**（不是100ms）
- [ ] 低电平持续 **500ms**
- [ ] 总周期 **1000ms**（1秒）

### 2. 套餐功能验证

| 选择套餐 | 发送脉冲数 | 预期设备运行时长 | 扣款金额 |
|---------|-----------|---------------|---------|
| "4 Min Wash" | 4个 | 4分钟 | $4.00 |
| "5 Min Wash" | 5个 | 5分钟 | $5.00 |
| "8 Min Wash" | 8个 | 8分钟 | $8.00 |
| "15 Min Wash" | 15个 | 15分钟 | $15.00 |

### 3. 串口监控

打开串口监视器（115200波特率），观察脉冲发送日志：

```
选择"5 Min Wash"时，应该看到：
"发送脉冲: 1/5"
"发送脉冲: 2/5"
"发送脉冲: 3/5"
"发送脉冲: 4/5"
"发送脉冲: 5/5"
"脉冲发送完成"
```

---

## 🔧 可选的后续优化

### 1. 增加处理超时时间（推荐）

15分钟套餐需要更长的超时：

```cpp
// config.h 第65行
#define STATE_TIMEOUT_PROCESSING_MS 960000  // 16分钟（15分钟+缓冲）
```

### 2. 显示剩余脉冲数（可选）

在displayWashProgress()中显示：

```cpp
sprintf(buffer, "Pulse %d/%d", current, total);
// 用户可以直观看到还剩多少脉冲
```

---

## 📚 详细文档

更多技术细节请参考：

- [NAYAX_PULSE_CONFIG_ANALYSIS.md](doc/NAYAX_PULSE_CONFIG_ANALYSIS.md) - 完整的配置分析
- [config.h](config.h) - 主配置文件
- [GoldSky_PulseControl.ino](GoldSky_PulseControl.ino) - 脉冲控制实现

---

## 🎯 为什么这些修改很重要？

### 脉冲宽度修正（100ms → 500ms）

**原配置问题**：
- 10%占空比的脉冲过窄
- 洗车设备可能无法识别
- 不符合ccTalk行业标准

**修正后优势**：
- ✅ 50%占空比易于检测
- ✅ 符合Nayax等商业系统标准
- ✅ 提高兼容性和可靠性

### 套餐配置修正

**原配置问题**：
- 显示时长与实际脉冲数不匹配
- 用户选择"6分钟"但设备运行8分钟
- 定价不规则（$4, $6, $9, $12）

**修正后优势**：
- ✅ 时长和脉冲数一致（透明清晰）
- ✅ 线性定价（$1/分钟）易于理解
- ✅ 匹配Nayax行业标准

---

**修改日期**: 2025-11-02
**状态**: ✅ 已完成，待测试
