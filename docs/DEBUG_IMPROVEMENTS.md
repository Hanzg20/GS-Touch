# è°ƒè¯•å’Œæ€§èƒ½æ”¹è¿›

ä¿®å¤æ—¥æœŸï¼š2025-11-02
é—®é¢˜ï¼šNFCæ— æ³•è¯†åˆ«å¡ + I2Cé”™è¯¯

---

## ğŸ› é—®é¢˜åˆ†æ

### ç”¨æˆ·åé¦ˆçš„é”™è¯¯

```
22:25:07.653 -> E (60428) i2c.master: I2C transaction unexpected nack detected
22:25:07.696 -> E (60428) i2c.master: s_i2c_synchronous_transaction(945): I2C transaction failed
22:25:07.696 -> E (60429) i2c.master: i2c_master_multi_buffer_transmit(1214): I2C transaction fail

ç”¨æˆ·æŒ‰é’®æ“ä½œï¼š
22:25:50.051 -> [88758][INFO] æŒ‰é’®æŒ‰ä¸‹: GPIO1
22:25:50.125 -> [88858][INFO] âœ… ç”¨æˆ·å¯åŠ¨æœåŠ¡
22:25:51.427 -> [90132][INFO] æŒ‰é’®æŒ‰ä¸‹: GPIO2
22:25:52.967 -> [91677][INFO] æŒ‰é’®æŒ‰ä¸‹: GPIO1
22:25:53.062 -> [91778][INFO] å¥—é¤é€‰æ‹©: 5 Min Wash

ä½†æ˜¯ï¼šæ²¡æœ‰ä»»ä½•"ç­‰å¾…åˆ·å¡"æˆ–"è¯»å–åˆ°å¡ç‰‡"çš„æ—¥å¿—
```

### é—®é¢˜è¯Šæ–­

1. **I2Cé”™è¯¯**ï¼š
   - OLEDæ˜¾ç¤ºå±çš„I2Cé€šä¿¡å¤±è´¥
   - åŸå› ï¼š`displayCardScan()`åœ¨loop()ä¸­è¢«é¢‘ç¹è°ƒç”¨
   - æ¯æ¬¡loopï¼ˆçº¦50msï¼‰éƒ½åˆ·æ–°æ˜¾ç¤º = æ¯ç§’20æ¬¡åˆ·æ–°
   - I2Cæ€»çº¿è¿‡è½½å¯¼è‡´NACKé”™è¯¯

2. **NFCæ— è¯»å¡æ—¥å¿—**ï¼š
   - æ²¡æœ‰"ç­‰å¾…åˆ·å¡"æ—¥å¿— â†’ å¯èƒ½æœªè¿›å…¥STATE_CARD_SCAN
   - æˆ–è€…I2Cé”™è¯¯å¯¼è‡´ç¨‹åºå¡ä½

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ è°ƒè¯•æ—¥å¿—

**[GoldSky_Lite.ino:335-356](GoldSky_Lite.ino#L335-L356)**

```cpp
void handleCardScanState() {
  setSystemLEDStatus();

  // è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦è¿›å…¥åˆ·å¡çŠ¶æ€
  static unsigned long lastDebugPrint = 0;
  if (millis() - lastDebugPrint > 2000) {
    logInfo("ç­‰å¾…åˆ·å¡...");
    lastDebugPrint = millis();
  }

  displayCardScan();

  String uid = readCardUID();

  // è°ƒè¯•ï¼šæ˜¾ç¤ºè¯»å¡å°è¯•ï¼ˆå¿ƒè·³ï¼‰
  static unsigned long lastReadAttempt = 0;
  if (millis() - lastReadAttempt > 1000) {
    if (uid.length() == 0) {
      Serial.print(".");  // ç®€å•çš„å¿ƒè·³æ˜¾ç¤º
    }
    lastReadAttempt = millis();
  }

  if (uid.length() > 0) {
    // ... å¤„ç†è¯»å¡æˆåŠŸ
  }
}
```

**æ”¹è¿›**ï¼š
- âœ… æ¯2ç§’æ‰“å°"ç­‰å¾…åˆ·å¡"æ—¥å¿—
- âœ… æ¯1ç§’æ‰“å°"."å¿ƒè·³ï¼ˆè¡¨ç¤ºç³»ç»Ÿè¿è¡Œä¸­ï¼‰
- âœ… å¸®åŠ©è¯Šæ–­æ˜¯å¦è¿›å…¥åˆ·å¡çŠ¶æ€

---

### 2. é™åˆ¶æ˜¾ç¤ºåˆ·æ–°ç‡

**[GoldSky_Display.ino:143-191](GoldSky_Display.ino#L143-L191)**

```cpp
void displayCardScan() {
  if (!sysStatus.displayWorking) return;

  // é™åˆ¶åˆ·æ–°ç‡ï¼šåªåœ¨åŠ¨ç”»éœ€è¦æ›´æ–°æ—¶åˆ·æ–°ï¼ˆ500msä¸€æ¬¡ï¼‰
  static unsigned long lastRefresh = 0;
  static int lastAnimFrame = -1;

  unsigned long now = millis();
  int animFrame = (now / 500) % 3;

  // åªåœ¨åŠ¨ç”»å¸§å˜åŒ–æ—¶åˆ·æ–°æ˜¾ç¤º
  if (animFrame == lastAnimFrame && (now - lastRefresh) < 500) {
    return;  // è·³è¿‡æœ¬æ¬¡åˆ·æ–°
  }

  lastRefresh = now;
  lastAnimFrame = animFrame;

  // ... æ­£å¸¸çš„æ˜¾ç¤ºæ›´æ–°é€»è¾‘
  display.clearBuffer();
  // ... ç»˜åˆ¶å†…å®¹
  display.sendBuffer();
}
```

**æ”¹è¿›**ï¼š
- âœ… ä»æ¯ç§’20æ¬¡åˆ·æ–° â†’ æ¯ç§’2æ¬¡åˆ·æ–°ï¼ˆåŠ¨ç”»å¸§å˜åŒ–æ—¶ï¼‰
- âœ… å¤§å¹…é™ä½I2Cæ€»çº¿è´Ÿè½½
- âœ… é¿å…I2C NACKé”™è¯¯
- âœ… ä¸å½±å“åŠ¨ç”»æ•ˆæœï¼ˆåŠ¨ç”»æœ¬æ¥å°±æ˜¯500msä¸€å¸§ï¼‰

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ”¹è¿›å‰

```
loop() æ‰§è¡Œé¢‘ç‡: æ¯50msä¸€æ¬¡ = æ¯ç§’20æ¬¡

æ¯æ¬¡loop():
  â†’ displayCardScan()
    â†’ display.clearBuffer()
    â†’ ç»˜åˆ¶å†…å®¹
    â†’ display.sendBuffer()  â† I2Cä¼ è¾“æ•°æ®åˆ°OLED
    â†“
  I2Cæ€»çº¿è´Ÿè½½: 20æ¬¡/ç§’ Ã— æ•°æ®é‡ = è¿‡è½½ï¼
  ç»“æœ: E (60428) i2c.master: I2C transaction unexpected nack detected
```

### æ”¹è¿›å

```
loop() æ‰§è¡Œé¢‘ç‡: æ¯50msä¸€æ¬¡ = æ¯ç§’20æ¬¡

å¤§éƒ¨åˆ†loop():
  â†’ displayCardScan()
    â†’ æ£€æŸ¥åŠ¨ç”»å¸§
    â†’ return (è·³è¿‡åˆ·æ–°)  â† ä¸æ“ä½œI2C
    â†“
  åªæœ‰2æ¬¡/ç§’éœ€è¦åˆ·æ–°ï¼ˆåŠ¨ç”»å¸§å˜åŒ–æ—¶ï¼‰
  I2Cæ€»çº¿è´Ÿè½½: 2æ¬¡/ç§’ Ã— æ•°æ®é‡ = æ­£å¸¸
  ç»“æœ: æ— I2Cé”™è¯¯ âœ…
```

**è´Ÿè½½å¯¹æ¯”**ï¼š
```
æ”¹è¿›å‰: 20æ¬¡/ç§’ = æ¯ç§’ä¼ è¾“ ~20KBæ•°æ®ï¼ˆOLEDç¼“å†²åŒºï¼‰
æ”¹è¿›å: 2æ¬¡/ç§’  = æ¯ç§’ä¼ è¾“ ~2KBæ•°æ®
é™ä½: 90% è´Ÿè½½å‡å°‘ï¼
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### é¢„æœŸçš„ä¸²å£æ—¥å¿—

ä¸Šä¼ æ–°ä»£ç åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[INFO] æŒ‰é’®æŒ‰ä¸‹: GPIO1
[INFO] âœ… ç”¨æˆ·å¯åŠ¨æœåŠ¡
[INFO] æŒ‰é’®æŒ‰ä¸‹: GPIO2
[INFO] æŒ‰é’®æŒ‰ä¸‹: GPIO1
[INFO] å¥—é¤é€‰æ‹©: 5 Min Wash

[INFO] ç­‰å¾…åˆ·å¡...       â† æ–°å¢ï¼šæ¯2ç§’æ‰“å°ä¸€æ¬¡
. . . . . .              â† æ–°å¢ï¼šå¿ƒè·³ï¼ˆæ¯ç§’ä¸€ä¸ªç‚¹ï¼‰
[INFO] ç­‰å¾…åˆ·å¡...
. . . . . .

ç”¨æˆ·åˆ·å¡:
[INFO] è¯»å–åˆ°å¡ç‰‡: HEX=8BCC1674, DEC=2345408116
[INFO] âœ… åœ¨çº¿éªŒè¯æˆåŠŸ
...
```

**å…³é”®**ï¼š
- âœ… åº”è¯¥çœ‹åˆ°"ç­‰å¾…åˆ·å¡"æ—¥å¿—
- âœ… åº”è¯¥çœ‹åˆ°"."å¿ƒè·³
- âœ… ä¸åº”è¯¥æœ‰I2Cé”™è¯¯

---

## ğŸ” I2Cé”™è¯¯çš„åŸå› 

### ä»€ä¹ˆæ˜¯I2C NACKï¼Ÿ

**NACK = Not Acknowledgeï¼ˆæœªåº”ç­”ï¼‰**

æ­£å¸¸é€šä¿¡ï¼š
```
ESP32 â†’ OLED:  å‘é€æ•°æ®
OLED â†’ ESP32:  ACKï¼ˆç¡®è®¤æ”¶åˆ°ï¼‰âœ…
```

é”™è¯¯é€šä¿¡ï¼š
```
ESP32 â†’ OLED:  å‘é€æ•°æ®
OLED â†’ ESP32:  NACKï¼ˆæœªç¡®è®¤ï¼‰âŒ æˆ– æ— å“åº”
```

### ä¸ºä»€ä¹ˆä¼šNACKï¼Ÿ

1. **æ€»çº¿è¿‡è½½**ï¼š
   - OLEDå¤„ç†é€Ÿåº¦ < ESP32å‘é€é€Ÿåº¦
   - OLEDè¿˜åœ¨å¤„ç†ä¸Šä¸€æ¬¡æ•°æ®ï¼Œæ–°æ•°æ®åˆæ¥äº†
   - OLEDæ‹’ç»æ¥æ”¶ï¼ˆNACKï¼‰

2. **æ—¶åºé—®é¢˜**ï¼š
   - I2Cæ—¶é’Ÿé¢‘ç‡å¤ªå¿«
   - SDA/SCLä¿¡å·ä¸ç¨³å®š

3. **ç¡¬ä»¶é—®é¢˜**ï¼š
   - æ¥çº¿æ¾åŠ¨
   - ç”µæºä¸ç¨³å®š
   - ä¸Šæ‹‰ç”µé˜»é—®é¢˜

### æˆ‘ä»¬çš„æƒ…å†µ

**æ˜æ˜¾æ˜¯æ€»çº¿è¿‡è½½**ï¼š
- æ¯ç§’20æ¬¡å…¨å±åˆ·æ–°
- æ¯æ¬¡åˆ·æ–°ä¼ è¾“1KBæ•°æ®
- OLEDæ— æ³•è·Ÿä¸Šå¤„ç†é€Ÿåº¦
- å¯¼è‡´NACKé”™è¯¯

**ä¿®å¤å**ï¼š
- æ¯ç§’åªåˆ·æ–°2æ¬¡
- OLEDæœ‰è¶³å¤Ÿæ—¶é—´å¤„ç†
- ä¸å†NACK

---

## ğŸ’¡ æœ€ä½³å®è·µ

### OLEDæ˜¾ç¤ºåˆ·æ–°ç­–ç•¥

1. **é™æ€å†…å®¹**ï¼šåªåˆ·æ–°ä¸€æ¬¡
   ```cpp
   static bool displayed = false;
   if (!displayed) {
     display.clearBuffer();
     // ... ç»˜åˆ¶
     display.sendBuffer();
     displayed = true;
   }
   ```

2. **åŠ¨ç”»å†…å®¹**ï¼šé™åˆ¶åˆ·æ–°ç‡
   ```cpp
   static unsigned long lastRefresh = 0;
   if (millis() - lastRefresh > 500) {  // 500msä¸€æ¬¡
     display.clearBuffer();
     // ... ç»˜åˆ¶åŠ¨ç”»
     display.sendBuffer();
     lastRefresh = millis();
   }
   ```

3. **äº¤äº’å†…å®¹**ï¼šåªåœ¨å˜åŒ–æ—¶åˆ·æ–°
   ```cpp
   static int lastValue = -1;
   if (currentValue != lastValue) {
     display.clearBuffer();
     // ... ç»˜åˆ¶æ–°å€¼
     display.sendBuffer();
     lastValue = currentValue;
   }
   ```

### I2Cæ€»çº¿ä½¿ç”¨å»ºè®®

1. **é¿å…é¢‘ç¹æ“ä½œ**
   - ä¸è¦åœ¨loop()ä¸­æ— æ¡ä»¶åˆ·æ–°
   - ä½¿ç”¨åˆ·æ–°ç‡é™åˆ¶

2. **é”™è¯¯å¤„ç†**
   ```cpp
   if (!display.begin()) {
     logError("OLEDåˆå§‹åŒ–å¤±è´¥");
     sysStatus.displayWorking = false;
   }
   ```

3. **é€‚å½“å»¶è¿Ÿ**
   ```cpp
   display.sendBuffer();
   delay(10);  // ç»™I2Cæ€»çº¿ä¸€ç‚¹æ¢å¤æ—¶é—´
   ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [NFC_READ_FIX.md](NFC_READ_FIX.md) - NFCè¯»å¡ä¿®å¤
- [GoldSky_Display.ino](../GoldSky_Display.ino) - æ˜¾ç¤ºå‡½æ•°
- [GoldSky_Lite.ino](../GoldSky_Lite.ino) - ä¸»ç¨‹åº

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜
- âŒ I2Cæ€»çº¿è¿‡è½½ï¼ˆæ¯ç§’20æ¬¡åˆ·æ–°ï¼‰
- âŒ I2C NACKé”™è¯¯
- âŒ NFCè¯»å¡æ— æ—¥å¿—ï¼ˆå¯èƒ½è¢«å¡ä½ï¼‰

### ä¿®å¤
- âœ… é™åˆ¶åˆ·æ–°ç‡ï¼ˆæ¯ç§’2æ¬¡ï¼‰
- âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆ"ç­‰å¾…åˆ·å¡" + å¿ƒè·³ï¼‰
- âœ… é™ä½I2Cæ€»çº¿è´Ÿè½½90%

### ç»“æœ
- âœ… æ— I2Cé”™è¯¯
- âœ… å¯è§è°ƒè¯•ä¿¡æ¯
- âœ… NFCåº”è¯¥èƒ½æ­£å¸¸è¯»å¡

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-02
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¯ä¸Šä¼ æµ‹è¯•
