# 齿轮动画设计文档

版本: v2.5
功能: 洗车进度页面 - 数字信号到齿轮动画

---

## 🎯 设计目标

将原来的静态进度条改为动态齿轮动画,直观展示:
- 数字脉冲信号的发送过程
- 信号驱动齿轮转动的机械感
- 工作进行中的视觉反馈

---

## 🎨 界面布局

### 优化前 (v2.4) - 进度条版本
```
┌─────────────────────────┐
│   Wash in Progress      │
│       04:35             │
│     Pulse 3/5           │
│                         │
│  ▓▓▓▓▓▓░░░░░░░         │ ← 静态进度条
└─────────────────────────┘
```

### 优化后 (v2.5) - 齿轮动画版本
```
┌─────────────────────────┐
│   Wash in Progress      │
│       04:35             │
│                         │
│ 1-0-1-0 → → → ⚙        │ ← 动画
│ 3/5            Gear     │
└─────────────────────────┘
```

**动画元素**:
- `1-0-1-0`: 数字信号从左向右流动
- `→ → →`: 箭头指向齿轮
- `⚙`: 齿轮旋转动画 (8齿)
- `3/5`: 脉冲计数
- `Gear`: 齿轮标签

---

## 🔧 技术实现

### 文件位置
**[GoldSky_Display.ino](GoldSky_Display.ino#L348-L435)**

### 核心组件

#### 1. 齿轮旋转动画
```cpp
// 齿轮旋转状态
static unsigned long lastGearUpdate = 0;
static int gearAngle = 0;

// 每200ms旋转45度
if (millis() - lastGearUpdate > 200) {
    gearAngle = (gearAngle + 45) % 360;
    lastGearUpdate = millis();
}

// 绘制8个齿
for (int i = 0; i < 8; i++) {
    int angle = (i * 45 + gearAngle) % 360;
    float rad = angle * 3.14159 / 180.0;
    // 计算齿的起点和终点
    int x1 = gearX + (gearRadius - 1) * cos(rad);
    int y1 = gearY + (gearRadius - 1) * sin(rad);
    int x2 = gearX + (gearRadius + 2) * cos(rad);
    int y2 = gearY + (gearRadius + 2) * sin(rad);
    display.drawLine(x1, y1, x2, y2);
}
```

**参数**:
- 旋转速度: 200ms/步
- 旋转角度: 45°/步 (360° ÷ 8齿)
- 齿轮半径: 8像素
- 齿数: 8个

---

#### 2. 数字信号流动动画
```cpp
// 信号流动状态
static unsigned long lastPulse = 0;
static int pulsePos = 0;

// 每150ms移动8像素
if (millis() - lastPulse > 150) {
    pulsePos = (pulsePos + 8) % 80;
    lastPulse = millis();
}

// 绘制 "1" "0" "1" "0" 数字流
for (int i = 0; i < 4; i++) {
    int digitX = area.x + 10 + pulsePos + (i * 20);
    if (digitX < gearX - 15) {  // 到达齿轮前显示
        const char* digit = (i % 2 == 0) ? "1" : "0";
        display.drawStr(digitX, animY + 10, digit);

        // 连接线
        display.drawLine(digitX - 5, animY + 9, digitX, animY + 9);
    }
}
```

**参数**:
- 流动速度: 150ms/步
- 移动距离: 8像素/步
- 循环长度: 80像素
- 数字间距: 20像素
- 数字序列: "1" "0" "1" "0" 交替

---

#### 3. 箭头指示
```cpp
// 箭头位置 (齿轮左侧20像素)
int arrowX = gearX - 20;

// 箭头线
display.drawLine(arrowX, animY + 9, arrowX + 8, animY + 9);

// 箭头头部
display.drawLine(arrowX + 8, animY + 9, arrowX + 5, animY + 6);
display.drawLine(arrowX + 8, animY + 9, arrowX + 5, animY + 12);
```

---

### 布局坐标

```
显示区域: 127 × 53 像素 (可视窗口)

Y=6   ┌─────────────────────────────┐
      │                             │
Y=15  │   Wash in Progress          │ ← 标题
Y=31  │       04:35                 │ ← 倒计时
      │                             │
Y=47  │ 1-0-1 → → ⚙                │ ← 动画层
      │ │        │  └─ 齿轮 (X=112)
      │ │        └─ 箭头 (X=92)
      │ └─ 数字信号 (X=10+pulsePos)
      │                             │
Y=56  │ 3/5          Gear           │ ← 标签层
Y=59  └─────────────────────────────┘

坐标说明:
- animY = 41 (动画起始Y)
- gearX = 112 (齿轮中心X)
- gearY = 50 (齿轮中心Y)
- 信号起点: X=10
```

---

## ⚙️ 动画参数配置

### 齿轮参数
```cpp
int gearX = area.x + area.width - 15;  // 齿轮X位置
int gearY = animY + 9;                 // 齿轮Y位置
int gearRadius = 8;                    // 齿轮半径
```

**可调整**:
- 齿轮大小: 修改 `gearRadius` (6-10)
- 齿轮位置: 修改 `area.width - 15` 中的15

### 旋转速度
```cpp
if (millis() - lastGearUpdate > 200) {  // 旋转间隔
```

**推荐值**:
- 快速: 100ms (更动感)
- 正常: 200ms (当前)
- 慢速: 300ms (更稳重)

### 信号流动速度
```cpp
if (millis() - lastPulse > 150) {  // 流动间隔
    pulsePos = (pulsePos + 8) % 80;  // 移动距离
```

**推荐值**:
- 快速: 100ms, 移动10像素
- 正常: 150ms, 移动8像素 (当前)
- 慢速: 200ms, 移动6像素

---

## 🎬 动画效果说明

### 1. 齿轮旋转
- **方向**: 顺时针
- **速度**: 1.8秒/圈 (200ms × 8步 ÷ 360°)
- **视觉**: 连续平滑旋转

### 2. 数字信号流
- **方向**: 从左到右
- **模式**: "1" "0" "1" "0" 交替
- **行为**:
  - 信号从屏幕左侧出现
  - 流向右侧齿轮
  - 到达齿轮附近消失
  - 循环往复

### 3. 箭头指示
- **作用**: 明确信号方向
- **位置**: 齿轮左侧
- **样式**: 简单线条箭头

---

## 💾 内存使用

**静态变量** (持久化):
```cpp
static unsigned long lastGearUpdate = 0;  // 4字节
static int gearAngle = 0;                 // 4字节
static unsigned long lastPulse = 0;       // 4字节
static int pulsePos = 0;                  // 4字节
```
**总计**: 16字节 (全局数据段)

**栈变量** (临时):
- 循环变量、计算结果等: ~20字节

**总内存开销**: <50字节 (可忽略)

---

## 🎯 设计理念

### 为什么用齿轮?
1. **直观性**: 齿轮是机械运动的通用符号
2. **动态感**: 旋转动画比静态条更生动
3. **专业性**: 符合洗车设备的工业形象
4. **教育性**: 帮助用户理解脉冲信号原理

### 为什么用数字流?
1. **技术感**: "1" "0" 代表数字信号
2. **流动性**: 从左到右的运动展示传输过程
3. **关联性**: 数字信号驱动齿轮,逻辑清晰
4. **趣味性**: 动画增加视觉吸引力

---

## 🔄 动画流程

```
开始洗车
   ↓
[标题: Wash in Progress]
[倒计时: 04:35]
   ↓
┌─────────────────────┐
│ 数字信号流动 →     │
│   "1" "0" "1"       │
│         ↓           │
│       箭头 →        │
│         ↓           │
│      ⚙ 齿轮旋转    │
└─────────────────────┘
   ↓
脉冲发送完成
   ↓
显示完成界面
```

---

## 🧪 测试要点

### 视觉测试
- [ ] 齿轮旋转流畅无卡顿
- [ ] 数字信号流动连贯
- [ ] 箭头位置正确指向齿轮
- [ ] 文字不与动画重叠
- [ ] 脉冲计数实时更新

### 性能测试
- [ ] 动画帧率稳定
- [ ] 无明显闪烁
- [ ] CPU占用正常
- [ ] 内存无泄漏

### 兼容性测试
- [ ] 不同脉冲数量下正常显示 (1-99)
- [ ] 倒计时正常更新
- [ ] 所有文字在可视区域内

---

## 🎨 ASCII艺术预览

```
┌─────────────────────────────┐
│    Wash in Progress         │
│         04:35               │
│                             │
│  1 ─ 0 ─ 1 ─ 0 → → →  ⚙   │
│                        ╱│╲  │
│  3/5               Gear    │
└─────────────────────────────┘

图例:
  1-0-1-0  : 数字信号流 (从左向右移动)
  → → →    : 信号传输方向
  ⚙        : 齿轮 (顺时针旋转)
  ╱│╲      : 齿轮的齿 (8个)
  3/5      : 脉冲计数
  Gear     : 齿轮标签
```

---

## 🔧 故障排查

### 齿轮不旋转
- 检查 `lastGearUpdate` 是否更新
- 确认 `gearAngle` 计算正确
- 验证三角函数库已引入

### 数字不流动
- 检查 `lastPulse` 是否更新
- 确认 `pulsePos` 循环正确
- 验证字符串绘制坐标

### 文字重叠
- 调整 `animY` 坐标
- 减小字体大小
- 调整元素间距

---

## 📚 相关文档

- [UI_ENHANCEMENT_V2.5.md](UI_ENHANCEMENT_V2.5.md) - UI优化总结
- [GoldSky_Display.ino](GoldSky_Display.ino) - 显示函数实现
- [OPTIMIZATION_SUMMARY_V2.5.md](OPTIMIZATION_SUMMARY_V2.5.md) - 整体优化

---

## 🎉 总结

齿轮动画相比传统进度条:
- ✅ 更直观展示工作原理
- ✅ 更生动的视觉效果
- ✅ 更专业的工业形象
- ✅ 更有趣的用户体验

内存开销极小 (<50字节),性能影响可忽略,是一个低成本高收益的优化。

---

**文档版本**: v1.0
**最后更新**: 2025-11-07
**状态**: ✅ 已实现,待测试
