# NFCè¯»å¡å¤±è´¥ä¼˜åŒ–æ–¹æ¡ˆ

**ä¼˜åŒ–æ—¥æœŸ**: 2025-11-11
**é—®é¢˜**: NFCè¯»å¡é¢‘ç¹å¤±è´¥ï¼Œæ—¥å¿—åˆ·å±
**çŠ¶æ€**: âœ… å·²ä¼˜åŒ–

---

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹æ—¥å¿—ï¼ˆä¼˜åŒ–å‰ï¼‰
```
01:23:56.113 â†’ ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...
01:23:57.472 â†’ âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥
01:23:57.556 â†’ ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...
01:23:57.594 â†’ âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥
01:23:57.661 â†’ ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...
01:23:57.661 â†’ âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥
...ï¼ˆé‡å¤10+æ¬¡ï¼‰
01:24:05.757 â†’ è¯»å–åˆ°å¡ç‰‡: HEX=8BCC1674
```

**ç»Ÿè®¡**ï¼š
- è¿ç»­å¤±è´¥ï¼š~20æ¬¡
- å¤±è´¥æ—¶é—´ï¼š8.2ç§’
- æ—¥å¿—è¾“å‡ºï¼š40+æ¡

### å¤±è´¥åŸå› 

1. **å¡ç‰‡ä½ç½®ä¸æ­£ç¡®** - ç”¨æˆ·æå‰æ”¾å¡ï¼Œè§’åº¦/è·ç¦»ä¸å¯¹
2. **MFRC522ç‰¹æ€§** - éœ€è¦å¤šæ¬¡å°è¯•æ‰èƒ½ç¨³å®šé€šä¿¡
3. **ä¿¡å·å¹²æ‰°** - ç”µç£å¹²æ‰°ã€é‡‘å±å¤–å£³å½±å“
4. **å¡ç‰‡è´¨é‡** - éƒ¨åˆ†å¡ç‰‡ä¿¡å·å¼±

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å‡å°‘æ—¥å¿—å™ªéŸ³

**æ–‡ä»¶**: [GoldSky_Utils.ino:288-300](GoldSky_Utils.ino:288-300)

#### ä¼˜åŒ–å‰
```cpp
if (!mfrc522.PICC_IsNewCardPresent()) {
  return "";
}

logInfo("ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...");  // âŒ æ¯æ¬¡éƒ½è®°å½•

if (!mfrc522.PICC_ReadCardSerial()) {
  nfcReadFailCount++;
  logError("âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥");  // âŒ æ¯æ¬¡éƒ½è®°å½•
  return "";
}
```

#### ä¼˜åŒ–å
```cpp
if (!mfrc522.PICC_IsNewCardPresent()) {
  return "";
}

// âœ… 2ç§’å†…åªè®°å½•ä¸€æ¬¡æ£€æµ‹æ—¥å¿—
static unsigned long lastDetectLog = 0;
if (millis() - lastDetectLog > 2000) {
  logInfo("ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...");
  lastDetectLog = millis();
}

if (!mfrc522.PICC_ReadCardSerial()) {
  nfcReadFailCount++;
  // âœ… è¿ç»­å¤±è´¥3æ¬¡åï¼Œæ¯3æ¬¡è®°å½•ä¸€æ¬¡
  if (nfcReadFailCount >= 3 && nfcReadFailCount % 3 == 0) {
    logError("âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥ (è¿ç»­" + String(nfcReadFailCount) + "æ¬¡)");
  }
  return "";
}
```

**æ•ˆæœ**ï¼š
- æ£€æµ‹æ—¥å¿—ï¼šä»æ¯æ¬¡ â†’ æ¯2ç§’ä¸€æ¬¡ï¼ˆå‡å°‘90%ï¼‰
- å¤±è´¥æ—¥å¿—ï¼šä»æ¯æ¬¡ â†’ æ¯3æ¬¡ä¸€æ¬¡ï¼ˆå‡å°‘66%ï¼‰

---

### 2. OLEDå±å¹•æ™ºèƒ½æç¤º

**æ–‡ä»¶**: [GoldSky_Display.ino:255-270](GoldSky_Display.ino:255-270)

#### ä¼˜åŒ–å‰
```cpp
const char* prompt = "TAP CARD";
display.drawStr(promptX, promptY, prompt);
```

#### ä¼˜åŒ–å
```cpp
const char* prompt;
if (nfcReadFailCount >= 10) {
  // âœ… è¿ç»­å¤±è´¥10æ¬¡ä»¥ä¸Šï¼Œæç¤ºç”¨æˆ·è°ƒæ•´
  prompt = "Adjust Card";
  // âœ… é—ªçƒå¸å¼•æ³¨æ„
  if ((millis() / 500) % 2 == 0) {
    display.setFont(u8g2_font_helvB10_tf);  // åŠ ç²—
  }
} else {
  prompt = "TAP CARD";
}
display.drawStr(promptX, promptY, prompt);
```

**æ•ˆæœ**ï¼š
- æ­£å¸¸è¯»å¡ï¼šæ˜¾ç¤º "TAP CARD"
- è¿ç»­å¤±è´¥10æ¬¡ï¼šæ˜¾ç¤º "Adjust Card" å¹¶é—ªçƒ

---

### 3. å…¨å±€å˜é‡å£°æ˜

**æ–‡ä»¶**: [GoldSky_Utils.ino:264](GoldSky_Utils.ino:264)

```cpp
// ä¿®æ”¹å‰
static int nfcReadFailCount = 0;  // âŒ staticé™åˆ¶è®¿é—®

// ä¿®æ”¹å
int nfcReadFailCount = 0;  // âœ… å…¨å±€å¯è®¿é—®
```

**æ–‡ä»¶**: [GoldSky_Display.ino:9](GoldSky_Display.ino:9)

```cpp
// å¤–éƒ¨å˜é‡å£°æ˜
extern int nfcReadFailCount;  // å¼•ç”¨GoldSky_Utils.inoä¸­çš„å˜é‡
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| æ£€æµ‹æ—¥å¿—é¢‘ç‡ | æ¯æ¬¡å°è¯• | æ¯2ç§’ | -90% |
| å¤±è´¥æ—¥å¿—é¢‘ç‡ | æ¯æ¬¡å¤±è´¥ | æ¯3æ¬¡å¤±è´¥ | -66% |
| æ—¥å¿—æ€»é‡ï¼ˆ8ç§’å†…ï¼‰ | 40+æ¡ | ~10æ¡ | -75% |
| ç”¨æˆ·æç¤º | é™æ€æ–‡å­— | åŠ¨æ€+é—ªçƒ | æ›´æ˜æ˜¾ |
| ç”¨æˆ·ä½“éªŒ | æ— åé¦ˆ | æœ‰æç¤º | å¤§å¹…æå‡ |

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1: æ­£å¸¸è¯»å¡ï¼ˆ1-2æ¬¡æˆåŠŸï¼‰
**æ—¥å¿—è¾“å‡º**ï¼š
```
ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...
è¯»å–åˆ°å¡ç‰‡: HEX=8BCC1674
```
**å±å¹•æ˜¾ç¤º**ï¼šTAP CARD

### åœºæ™¯2: å¡ç‰‡ä½ç½®ä¸å¯¹ï¼ˆ5-10æ¬¡å¤±è´¥ï¼‰
**æ—¥å¿—è¾“å‡º**ï¼š
```
ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...
âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥ (è¿ç»­3æ¬¡)
âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥ (è¿ç»­6æ¬¡)
âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥ (è¿ç»­9æ¬¡)
è¯»å–åˆ°å¡ç‰‡: HEX=8BCC1674
```
**å±å¹•æ˜¾ç¤º**ï¼šTAP CARD

### åœºæ™¯3: å¡ç‰‡ä¸¥é‡é”™ä½ï¼ˆ10+æ¬¡å¤±è´¥ï¼‰
**æ—¥å¿—è¾“å‡º**ï¼š
```
ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...
âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥ (è¿ç»­3æ¬¡)
âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥ (è¿ç»­6æ¬¡)
âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥ (è¿ç»­9æ¬¡)
ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...  â† 2ç§’åå†æ¬¡æç¤º
âŒ è¯»å–å¡ç‰‡åºåˆ—å·å¤±è´¥ (è¿ç»­12æ¬¡)
è¯»å–åˆ°å¡ç‰‡: HEX=8BCC1674
```
**å±å¹•æ˜¾ç¤º**ï¼š**Adjust Card** ï¼ˆé—ªçƒï¼‰

---

## ğŸ¯ ç”¨æˆ·æ“ä½œæµç¨‹

### ç”¨æˆ·è§†è§’

1. **æ­£å¸¸ä½¿ç”¨**
   - æ”¾å¡ â†’ çœ‹åˆ° "TAP CARD" â†’ 1-2ç§’è¯»å–æˆåŠŸ âœ…

2. **å¡ç‰‡ä½ç½®ä¸å¯¹**
   - æ”¾å¡ â†’ çœ‹åˆ° "TAP CARD" â†’ ç­‰å¾…3-5ç§’ â†’ ä»æœªæˆåŠŸ
   - å±å¹•å˜ä¸º **"Adjust Card"** å¹¶é—ªçƒ
   - è°ƒæ•´å¡ç‰‡ä½ç½® â†’ è¯»å–æˆåŠŸ âœ…

3. **å¡ç‰‡æŸå/ä¸æ”¯æŒ**
   - æ”¾å¡ â†’ "Adjust Card" é—ªçƒ
   - è°ƒæ•´å¤šæ¬¡ä»å¤±è´¥
   - æ›´æ¢å¡ç‰‡æˆ–è”ç³»å®¢æœ

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å¤±è´¥è®¡æ•°é‡ç½®æ—¶æœº

```cpp
// æˆåŠŸè¯»å¡åç«‹å³é‡ç½®
if (decimalUID.length() > 0) {
  nfcReadFailCount = 0;  // âœ… é‡ç½®è®¡æ•°
  return decimalUID;
}
```

### æ£€æµ‹æ—¥å¿—é˜²æŠ–

```cpp
static unsigned long lastDetectLog = 0;
if (millis() - lastDetectLog > 2000) {  // 2ç§’é˜²æŠ–
  logInfo("ğŸ” æ£€æµ‹åˆ°å¡ç‰‡ï¼Œæ­£åœ¨è¯»å–...");
  lastDetectLog = millis();
}
```

### é—ªçƒåŠ¨ç”»å®ç°

```cpp
if (nfcReadFailCount >= 10) {
  prompt = "Adjust Card";
  // 500mså‘¨æœŸé—ªçƒï¼š500msæ­£å¸¸ï¼Œ500msåŠ ç²—
  if ((millis() / 500) % 2 == 0) {
    display.setFont(u8g2_font_helvB10_tf);  // å¶æ•°å‘¨æœŸåŠ ç²—
  }
  // å¥‡æ•°å‘¨æœŸä½¿ç”¨é»˜è®¤å­—ä½“ï¼ˆå·²åœ¨å‰é¢è®¾ç½®ï¼‰
}
```

---

## ğŸ’¡ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰ï¼‰

### 1. æ·»åŠ èœ‚é¸£å™¨æç¤º
```cpp
if (nfcReadFailCount == 10) {
  beepError();  // ç¬¬ä¸€æ¬¡è¾¾åˆ°10æ¬¡æ—¶èœ‚é¸£æç¤º
}
```

### 2. è‡ªåŠ¨é‡ç½®NFCæ¨¡å—
```cpp
if (nfcReadFailCount >= 20) {
  logWarn("è¿ç»­å¤±è´¥20æ¬¡ï¼Œé‡ç½®NFCæ¨¡å—");
  mfrc522.PCD_Init(RC522_CS, RC522_RST);
  nfcReadFailCount = 0;
}
```

### 3. ç»Ÿè®¡åˆ†æ
```cpp
// è®°å½•æ¯å¼ å¡çš„å¤±è´¥æ¬¡æ•°
struct CardStats {
  String uid;
  int failCount;
  int successCount;
};
```

---

## âœ… éƒ¨ç½²æ¸…å•

- [x] ä¿®æ”¹ `readCardUID()` å‡å°‘æ—¥å¿—è¾“å‡º
- [x] ä¿®æ”¹ `displayCardScan()` æ·»åŠ æ™ºèƒ½æç¤º
- [x] å°† `nfcReadFailCount` æ”¹ä¸ºå…¨å±€å˜é‡
- [x] æ·»åŠ  extern å£°æ˜
- [x] åˆ›å»ºæœ¬æ–‡æ¡£

**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¾…æµ‹è¯•éªŒè¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-11-11
**ä½œè€…**: Claude Code
