# 🚀 GoldSky_Lite 快速部署指南

**目标：5分钟完成设备部署**

---

## 📦 部署前准备

### 硬件清单
- [x] ESP32-S3 开发板
- [x] RC522 NFC 模块
- [x] SSD1306 OLED 显示屏（128x64）
- [x] 2个按钮（OK + SELECT）
- [x] 3个LED（红/绿/蓝）
- [x] 1个蜂鸣器
- [x] 连接线若干

### 软件准备
- [x] Arduino IDE 2.x
- [x] ESP32 开发板支持包
- [x] 必需库：
  - U8g2 (OLED显示)
  - MFRC522 (NFC读卡)
  - ArduinoJson (数据解析)

---

## ⚡ 5分钟快速部署

### 步骤 1：配置参数（2分钟）

打开 `GoldSky_Lite.ino`，修改以下配置（第56-70行）：

```cpp
// =================== 📌 必须修改的配置 ===================

// 1️⃣ WiFi配置（改成你的WiFi）
#define WIFI_SSID       "YOUR_WIFI_NAME"      // 修改这里
#define WIFI_PASSWORD   "YOUR_WIFI_PASSWORD"  // 修改这里

// 2️⃣ 机器ID（每台设备唯一）
#define MACHINE_ID "EAGLESON_TERMINAL_02"  // 改成 01, 02, 03...

// 3️⃣ Supabase配置（如果使用云端）
#define SUPABASE_URL "https://your-project.supabase.co"
#define SUPABASE_KEY "your-api-key-here"

// 4️⃣ 调试模式（生产环境改为 false）
#define DEBUG_MODE true  // 调试完成后改为 false
```

### 步骤 2：验证接线（1分钟）

**NFC模块（RC522）→ ESP32-S3**
```
SDA  → GPIO 10
SCK  → GPIO 12
MOSI → GPIO 11
MISO → GPIO 13
RST  → GPIO 14
3.3V → 3.3V
GND  → GND
```

**OLED显示屏 → ESP32-S3**
```
SDA → GPIO 8
SCL → GPIO 9
VCC → 3.3V
GND → GND
```

**按钮和LED**
```
OK按钮     → GPIO 1
SELECT按钮 → GPIO 2
绿色LED    → GPIO 5
蓝色LED    → GPIO 6
红色LED    → GPIO 7
蜂鸣器     → GPIO 16
脉冲输出   → GPIO 4
```

### 步骤 3：上传固件（2分钟）

1. 打开 Arduino IDE
2. 选择开发板：**ESP32S3 Dev Module**
3. 选择串口
4. 点击**上传**按钮
5. 等待编译和上传完成

### 步骤 4：验证运行（1分钟）

打开串口监视器（115200波特率），应该看到：

```
=====================================
🚗 EAGLESON_TERMINAL_02 v5.1
📡 WiFi SSID: YOUR_WIFI_NAME
🔧 调试模式: 开启
=====================================
📡 初始化 SPI和NFC...
RC522 固件版本: 0x92 ✅
🖥️ 初始化 U8g2 OLED...
✅ U8g2 OLED 初始化成功!
✅ 系统初始化完成!
```

---

## ✅ 功能测试清单

部署完成后，按顺序测试：

### 基础功能
- [ ] OLED显示正常（显示欢迎界面）
- [ ] LED灯自检（红绿蓝依次亮起）
- [ ] 蜂鸣器正常（启动时鸣叫）
- [ ] 按钮响应（按OK键进入语言选择）

### WiFi连接
- [ ] WiFi连接成功（查看串口日志）
- [ ] IP地址获取（记录IP地址）
- [ ] WiFi断开重连（拔掉路由器电源测试）

### NFC读卡
- [ ] 刷卡响应（卡片靠近时蓝灯亮起）
- [ ] UID读取（串口显示卡片UID）
- [ ] 卡片类型识别（显示MIFARE 1K/4K等）
- [ ] 防重复读取（2秒内连续刷卡只处理一次）

### 业务流程
- [ ] 语言选择（英/法/中）
- [ ] 套餐选择（4种套餐）
- [ ] 支付确认（显示余额和扣款金额）
- [ ] 脉冲输出（GPIO4输出脉冲信号）
- [ ] 完成提示（显示完成画面）

### 错误处理
- [ ] 余额不足提示
- [ ] 无效卡片提示
- [ ] WiFi断线恢复
- [ ] 超时自动返回待机

---

## 🔧 常见问题快速解决

### 问题 1：RC522 初始化失败（0x00）

**症状：** 串口显示 `RC522 固件版本: 0x00`

**解决方法：**
1. 检查接线（特别是MOSI/MISO是否接反）
2. 测量RC522供电电压（应为3.2-3.4V）
3. 尝试更换RC522模块

### 问题 2：OLED 无显示

**症状：** 屏幕黑屏，无任何显示

**解决方法：**
1. 检查I2C地址（默认0x3C）
2. 确认SDA/SCL接线正确
3. 测量OLED供电电压

### 问题 3：WiFi 连接失败

**症状：** 串口显示 `WiFi连接失败，使用离线模式`

**解决方法：**
1. 检查SSID和密码是否正确
2. 确认路由器2.4GHz频段开启（ESP32不支持5GHz）
3. 尝试靠近路由器
4. 检查路由器是否开启MAC地址过滤

### 问题 4：刷卡无反应

**症状：** 卡片靠近RC522无任何提示

**解决方法：**
1. 确认RC522初始化成功（版本号0x91或0x92）
2. 检查天线状态（串口日志显示"天线已开启"）
3. 尝试不同的NFC卡片（确保是ISO14443A标准）
4. 调整卡片与RC522的距离（2-5cm）

### 问题 5：系统频繁重启

**症状：** 设备运行一段时间后自动重启

**解决方法：**
1. 检查供电是否稳定（建议使用外部5V 2A电源）
2. 查看串口日志中的内存警告
3. 调整看门狗超时时间（从30秒改为60秒）
4. 关闭调试模式减少内存占用

---

## 🎯 生产环境部署建议

### 正式部署前修改

1. **关闭调试模式**
```cpp
#define DEBUG_MODE false  // 生产环境必须关闭
```

2. **设置唯一机器ID**
```cpp
#define MACHINE_ID "EAGLESON_STORE_01_TERMINAL_01"
// 格式：店铺代码_终端编号
```

3. **优化超时参数**
```cpp
// 根据实际使用情况调整
#define STATE_TIMEOUT_LANGUAGE_MS 20000   // 语言选择20秒
#define STATE_TIMEOUT_SELECT_MS 30000     // 套餐选择30秒
#define STATE_TIMEOUT_CARD_SCAN_MS 20000  // 刷卡20秒
```

4. **配置错误恢复**
```cpp
#define MAX_CONSECUTIVE_ERRORS 3  // 连续3次错误自动重置
#define AUTO_RESTART_TIMEOUT_MS 600000  // 10分钟无操作自动重启
```

### 批量部署清单

部署多台设备时，每台必须修改：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| MACHINE_ID | 每台唯一 | EAGLESON_S1_T01, T02, T03... |
| WIFI_SSID | 本地WiFi | Store_WiFi |
| WIFI_PASSWORD | WiFi密码 | ******** |
| DEBUG_MODE | 关闭调试 | false |

---

## 📊 性能基准

### 正常运行指标

**启动时间：** 约10秒
**内存占用：** 60-80KB（剩余200KB+）
**WiFi连接：** 5-10秒
**刷卡响应：** <500ms
**完整交易：** 10-15秒（从刷卡到完成）
**看门狗超时：** 30秒（可调整到60秒）
**稳定运行：** 7×24小时无重启

### 异常指标（需要检查）

- ⚠️ 内存剩余 < 40KB
- ⚠️ Loop循环时间 > 500ms
- ⚠️ WiFi重连 > 3次/小时
- ⚠️ NFC读卡失败 > 10%
- ⚠️ 系统重启 > 1次/天

---

## 📝 维护建议

### 日常维护（每周）

1. 检查串口日志
2. 观察内存占用趋势
3. 清洁NFC天线表面
4. 检查LED和蜂鸣器工作状态

### 定期维护（每月）

1. 更新固件（如有新版本）
2. 备份交易数据
3. 检查WiFi信号强度
4. 测试所有功能

### 升级建议（每季度）

1. 评估用户反馈
2. 优化超时参数
3. 调整套餐价格
4. 更新多语言文本

---

## 🆘 技术支持

### 日志收集

如果遇到问题，请收集以下信息：

1. **完整串口日志**（从启动到出错）
2. **设备信息**
   - 固件版本
   - 机器ID
   - WiFi SSID
   - 内存占用

3. **问题描述**
   - 出现频率
   - 触发条件
   - 用户操作步骤

### 远程诊断

启用远程调试模式：

```cpp
#define DEBUG_MODE true      // 开启详细日志
#define ENABLE_REMOTE_LOG true  // 上传日志到云端
```

---

## 📚 相关文档

- [优化指南](OPTIMIZATION_GUIDE.md) - 详细优化方案
- [RC522测试程序](RC522_Test.ino) - 硬件诊断工具
- [API文档] - Supabase接口说明
- [硬件接线图] - 完整接线示意图

---

## 🎉 部署完成

恭喜！你已经成功部署 GoldSky_Lite 洗车终端系统。

**下一步：**
1. 进行完整的功能测试
2. 根据实际使用情况调整参数
3. 实施优化指南中的建议
4. 监控系统运行状态

**如有问题，请查看常见问题部分或联系技术支持。**

祝运营顺利！🚗💦
