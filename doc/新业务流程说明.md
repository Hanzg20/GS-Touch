# GoldSky Touch Phase 1 v2.0 - 新业务流程说明

## 📋 业务逻辑流程

### 新版本流程对比

#### v1.0 流程（旧版）
```
IDLE → 检测卡片 → SELECT_PACKAGE → CONFIRM → PROCESSING → COMPLETE
```

#### v2.0 流程（新版）
```
IDLE → LANGUAGE_SELECT → SELECT_PACKAGE → CARD_SCAN → CONFIRM → PROCESSING → COMPLETE
```

---

## 🎯 详细流程说明

### 状态 1: 待机界面 (STATE_IDLE)

**显示内容**:
```
┌─────────────────────────┐
│  GoldSky Car Wash       │
│                         │
│       Welcome           │
│                         │
│    Press OK to start    │
└─────────────────────────┘
```

**用户操作**:
- 点击 **OK** 按钮开始

**LED状态**: 🟢 绿灯常亮

---

### 状态 2: 语言选择 (STATE_LANGUAGE_SELECT)

**显示内容**:
```
┌─────────────────────────┐
│  Select Language        │
├─────────────────────────┤
│ [1] English    ←高亮    │
│ [2] Français            │
│ [3] 中文                │
└─────────────────────────┘
```

**用户操作**:
- **SELECT** 按钮切换语言（循环切换：英语→法语→中文→英语）
- **OK** 按钮确认选择并进入下一步

**默认语言**: 英语 (English)

**LED状态**: 🔵 蓝灯常亮

**超时**: 20秒无操作自动返回待机

---

### 状态 3: 套餐选择 (STATE_SELECT_PACKAGE)

**显示内容**:
```
┌─────────────────────────┐
│  Select Package       │
├─────────────────────────┤
│ [1] 5min   $10  ←高亮 │
│ [2] 10min  $15        │
│ [3] 15min  $20        │
│ [4] 30min  $30        │
└─────────────────────────┘
```

**用户操作**:
- **SELECT** 按钮 ('$'键) 切换套餐
- **OK** 按钮确认选择

**套餐配置**:
- 套餐 1: Quick Wash - 5分钟 - $10 - 5个脉冲
- 套餐 2: Standard - 10分钟 - $15 - 10个脉冲
- 套餐 3: Deluxe - 15分钟 - $20 - 15个脉冲
- 套餐 4: Premium - 30分钟 - $30 - 30个脉冲

**LED状态**: 🔵 蓝灯常亮

**超时**: 30秒无操作自动返回待机

---

### 状态 4: 刷卡检测 (STATE_CARD_SCAN)

**显示内容**:
```
┌─────────────────────────┐
│   Please Tap Card       │
├─────────────────────────┤
│                         │
│       ◉ ◯ ◉             │
│        NFC              │
│                         │
│      Scanning...        │
└─────────────────────────┘
```

**用户操作**:
- 将 NFC 卡片贴近读卡器

**系统流程**:
1. 检测到卡片后读取 UID
2. 查询数据库获取卡片信息
3. 显示卡片详细信息

**LED状态**: 🔵 蓝灯常亮

**超时**: 15秒未检测到卡片返回套餐选择

---

### 状态 4.5: 卡片信息显示

**检测到卡片后显示**:
```
┌─────────────────────────┐
│   Card Detected         │
├─────────────────────────┤
│ Card: CARD-4F8E         │
│ Balance: $50.00         │
│ Status: Active          │
│                         │
│ Press OK to continue    │
└─────────────────────────┘
```

**显示信息**:
- 卡号
- 余额
- 激活状态
- 用户状态

**系统验证**:
- ✅ 卡片是否有效
- ✅ 卡片是否激活
- ✅ 余额是否足够

**验证失败**:
- ❌ 余额不足 → 显示错误，3秒后返回待机
- ❌ 卡片无效 → 显示错误，3秒后返回待机

**LED状态**: 🔵 蓝灯闪烁

---

### 状态 5: 确认支付 (STATE_CONFIRM)

**显示内容**:
```
┌─────────────────────────┐
│  Confirm Order          │
├─────────────────────────┤
│ Package: Standard       │
│ Time: 10 min            │
│ Price: $15              │
├─────────────────────────┤
│ OK:Yes  SEL:Back        │
└─────────────────────────┘
```

**用户操作**:
- **OK** 按钮 → 确认并开始支付
- **SELECT** 按钮 → 返回套餐选择

**确认后**:
1. 扣除余额（从数据库）
2. 记录交易
3. 进入脉冲发送状态

**LED状态**: 🔵 蓝灯闪烁

**超时**: 15秒无操作返回套餐选择

---

### 状态 6: 发送脉冲 (STATE_PROCESSING)

**显示内容**:
```
┌─────────────────────────┐
│  Processing...          │
├─────────────────────────┤
│                         │
│      10/15              │
│        67%              │
│                         │
│    ━━━━━━━━━━ ━━━━     │
└─────────────────────────┘
```

**系统流程**:
1. 根据选择的套餐发送对应数量的脉冲
2. 每5个脉冲响一声蜂鸣器
3. 显示进度条和百分比

**脉冲配置**:
- 脉冲宽度: 100ms
- 脉冲间隔: 1000ms (1秒)
- 脉冲电压: 5V

**LED状态**: 🔵 蓝灯闪烁

**超时**: 120秒（最多30个脉冲 × 4秒）

---

### 状态 7: 完成提示 (STATE_COMPLETE)

**显示内容**:
```
┌─────────────────────────┐
│   Complete!             │
├─────────────────────────┤
│                         │
│         ✓              │
│                         │
│    10 min started       │
└─────────────────────────┘
```

**系统流程**:
1. 显示对号图标
2. 显示已启动的时长
3. 播放成功提示音
4. 5秒后自动返回待机

**LED状态**: 🟢 绿灯常亮

**超时**: 10秒后自动返回待机

---

## 🔍 关键改进点

### 1. 新增语言选择界面

**优势**:
- ✅ 支持多语言（英、法、中）
- ✅ 用户体验更好
- ✅ 适合国际化部署

**实现**:
```cpp
enum Language {
  LANG_EN,  // 英语
  LANG_FR,  // 法语
  LANG_CN   // 中文
};
```

---

### 2. 刷卡时机优化

**旧版**: 开始时刷卡 → 可能出现余额不足但仍可以选择套餐

**新版**: 套餐选择后刷卡 → 更符合支付流程，减少无效操作

---

### 3. 卡片信息展示

**新增信息**:
- 卡号
- 余额
- 激活状态
- 用户状态

**验证流程**:
```cpp
1. 读取卡片 UID
2. 查询数据库获取卡片信息
3. 检查余额是否足够
4. 检查卡片是否激活
5. 显示卡片信息或错误提示
```

---

### 4. 余额验证

**在刷卡后立即验证**:
```cpp
if (currentCardInfo.balance >= packages[selectedPackage].price) {
  // 余额足够，进入确认界面
} else {
  // 余额不足，显示错误并返回待机
  handleError("Insufficient Balance");
}
```

---

## 📊 状态超时配置

| 状态 | 超时时间 | 超时操作 |
|-----|---------|---------|
| IDLE | 无限制 | - |
| LANGUAGE_SELECT | 20秒 | 返回 IDLE |
| SELECT_PACKAGE | 30秒 | 返回 IDLE |
| CARD_SCAN | 15秒 | 返回 SELECT_PACKAGE |
| CONFIRM | 15秒 | 返回 SELECT_PACKAGE |
| PROCESSING | 120秒 | 返回 IDLE |
| COMPLETE | 10秒 | 返回 IDLE |

---

## 🎨 LED 状态指示

| 状态 | LED颜色 | 模式 | 说明 |
|-----|--------|------|------|
| IDLE | 🟢 绿 | 常亮 | 待机状态 |
| LANGUAGE_SELECT | 🔵 蓝 | 常亮 | 选择中 |
| SELECT_PACKAGE | 🔵 蓝 | 常亮 | 选择中 |
| CARD_SCAN | 🔵 蓝 | 常亮 | 扫描中 |
| CONFIRM | 🔵 蓝 | 闪烁 | 确认中 |
| PROCESSING | 🔵 蓝 | 闪烁 | 处理中 |
| COMPLETE | 🟢 绿 | 常亮 | 完成 |
| ERROR | 🔴 红 | 闪烁 | 错误 |

---

## 🐛 错误处理

### 错误类型

1. **卡片无效**
   - 显示: "Card Invalid"
   - 操作: 3秒后返回待机

2. **余额不足**
   - 显示: "Insufficient Balance"
   - 操作: 3秒后返回待机

3. **刷卡超时**
   - 显示: 返回套餐选择
   - 操作: 自动返回上一步

4. **系统错误**
   - 显示: "System Error"
   - 操作: 5秒后返回待机

---

## 💡 用户体验优化

### 1. 渐进式流程
每个步骤都有明确的提示和反馈

### 2. 可返回性
在确认界面可以返回到套餐选择

### 3. 明确的视觉反馈
- LED 颜色变化
- 蜂鸣器声音
- OLED 显示更新

### 4. 超时保护
防止用户在某个状态停留过久

---

## 📝 开发建议

### 需要完成的功能

#### 高优先级 (P1)
- [x] 语言选择界面
- [x] 刷卡时机调整
- [x] 卡片信息展示
- [ ] 实际 Supabase 集成 (当前是模拟数据)

#### 中优先级 (P2)
- [ ] 卡片白名单验证
- [ ] NFC 读取重试机制
- [ ] 脉冲发送验证
- [ ] 多语言文字内容完善

#### 低优先级 (P3)
- [ ] 刷卡动画效果
- [ ] 语音提示
- [ ] 交易数据导出
- [ ] 配置菜单

---

## 🎉 总结

### v2.0 核心改进

1. ✅ **语言选择** - 支持英、法、中三种语言
2. ✅ **刷卡优化** - 套餐选择后再刷卡
3. ✅ **信息展示** - 完整显示卡片信息和用户状态
4. ✅ **余额验证** - 立即检查余额是否足够
5. ✅ **错误处理** - 完善的错误提示和恢复机制

### 用户体验提升

- 📱 更符合真实支付流程
- 🎯 减少无效操作
- 🔒 安全性更高
- 🌐 支持多语言
- ⚡ 响应更快

---

**最后更新**: 2024-01-28  
**版本**: v2.0  
**状态**: ✅ 核心流程完成，待实际数据库集成
