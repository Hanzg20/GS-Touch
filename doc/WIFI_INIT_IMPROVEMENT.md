# WiFiåˆå§‹åŒ–æ”¹è¿› - è‡ªåŠ¨é‡è¯•å’Œé‡è¿æœºåˆ¶

æ”¹è¿›æ—¥æœŸï¼š2025-11-02
é—®é¢˜ï¼šWiFiè¿æ¥è¶…æ—¶20ç§’åæ”¾å¼ƒï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶

---

## ğŸ› åŸé—®é¢˜åˆ†æ

### ç”¨æˆ·åé¦ˆçš„æ—¥å¿—

```
21:43:08.004 -> [2782][INFO] è¿æ¥WiFi: hanzg_hanyh
21:43:08.523 -> ........................................
21:43:28.041 -> [22828][WARN] âš ï¸ WiFiè¿æ¥å¤±è´¥ï¼Œç¦»çº¿æ¨¡å¼
```

**æ—¶é—´çº¿**ï¼š
- å¼€å§‹è¿æ¥ï¼š2782ms
- è¶…æ—¶å¤±è´¥ï¼š22828ms
- **è€—æ—¶ï¼š20ç§’ï¼ˆç­‰äºWIFI_TIMEOUT_MS = 20000ï¼‰**

### åŸä»£ç é—®é¢˜

```cpp
void initWiFi() {
  logInfo("è¿æ¥WiFi: " + String(WIFI_SSID));
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  unsigned long startTime = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startTime < WIFI_TIMEOUT_MS) {
    delay(500);
    Serial.print(".");
  }

  if (WiFi.status() == WL_CONNECTED) {
    sysStatus.wifiConnected = true;
    Serial.println();
    logInfo("âœ… WiFiè¿æ¥æˆåŠŸ: " + WiFi.localIP().toString());
  } else {
    sysStatus.wifiConnected = false;
    Serial.println();
    logWarn("âš ï¸ WiFiè¿æ¥å¤±è´¥ï¼Œç¦»çº¿æ¨¡å¼");  // âŒ ç›´æ¥æ”¾å¼ƒ
  }
}
```

**é—®é¢˜**ï¼š
1. åªå°è¯•1æ¬¡ï¼Œç­‰å¾…20ç§’è¶…æ—¶å°±æ”¾å¼ƒ
2. æ²¡æœ‰é‡è¯•æœºåˆ¶
3. æ€»è€—æ—¶è¿‡é•¿ï¼ˆ20ç§’ï¼‰å½±å“å¯åŠ¨é€Ÿåº¦

**å¯èƒ½çš„å¤±è´¥åŸå› **ï¼š
- è·¯ç”±å™¨æœªå®Œå…¨å¯åŠ¨
- WiFiä¿¡å·æš‚æ—¶ä¸ç¨³å®š
- DHCPæœåŠ¡å™¨å“åº”æ…¢
- ESP32 WiFiæ¨¡å—æœªå®Œå…¨åˆå§‹åŒ–

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å¯åŠ¨æ—¶é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡ï¼Œæ¯æ¬¡10ç§’ï¼‰

**[GoldSky_Lite.ino:71-108](../GoldSky_Lite.ino#L71-L108)**

```cpp
void initWiFi() {
  logInfo("è¿æ¥WiFi: " + String(WIFI_SSID));

  // WiFiåˆå§‹åŒ–å¸¦é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
  sysStatus.wifiConnected = false;
  WiFi.mode(WIFI_STA);

  for (int retry = 0; retry < 3; retry++) {
    if (retry > 0) {
      logWarn("âš ï¸ WiFié‡è¿å°è¯• " + String(retry) + "/3");
      WiFi.disconnect();  // å…ˆæ–­å¼€
      delay(1000);        // ç­‰å¾…1ç§’
    }

    WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

    // ç­‰å¾…è¿æ¥ï¼ˆæ¯æ¬¡å°è¯•10ç§’ï¼Œä¸æ˜¯20ç§’ï¼‰
    unsigned long startTime = millis();
    while (WiFi.status() != WL_CONNECTED && millis() - startTime < 10000) {
      delay(500);
      Serial.print(".");
    }

    if (WiFi.status() == WL_CONNECTED) {
      sysStatus.wifiConnected = true;
      Serial.println();
      logInfo("âœ… WiFiè¿æ¥æˆåŠŸ: " + WiFi.localIP().toString() +
              (retry > 0 ? " (é‡è¯•æˆåŠŸ)" : ""));
      return;  // âœ… æˆåŠŸåç«‹å³è¿”å›
    }

    Serial.println();  // æ¢è¡Œ
  }

  // 3æ¬¡éƒ½å¤±è´¥
  sysStatus.wifiConnected = false;
  logWarn("âš ï¸ WiFiè¿æ¥å¤±è´¥ï¼ˆ3æ¬¡é‡è¯•åï¼‰ï¼Œè¿›å…¥ç¦»çº¿æ¨¡å¼");
}
```

**æ”¹è¿›è¦ç‚¹**ï¼š
- âœ… æœ€å¤šé‡è¯•3æ¬¡ï¼ˆæ¯æ¬¡10ç§’ = æœ€å¤š30ç§’ï¼‰
- âœ… æ¯æ¬¡é‡è¯•å‰å…ˆæ–­å¼€è¿æ¥
- âœ… é‡è¯•å‰å»¶è¿Ÿ1ç§’ç­‰å¾…WiFiæ¨¡å—å¤ä½
- âœ… æˆåŠŸåç«‹å³è¿”å›ï¼Œä¸æµªè´¹æ—¶é—´
- âœ… æ˜¾ç¤ºæ˜¯å¦é‡è¯•æˆåŠŸ

**æ—¶é—´å¯¹æ¯”**ï¼š
```
åŸæ–¹æ¡ˆ: 1æ¬¡ Ã— 20ç§’ = 20ç§’ï¼ˆå¤±è´¥å°±æ”¾å¼ƒï¼‰
æ–°æ–¹æ¡ˆ: 3æ¬¡ Ã— 10ç§’ = æœ€å¤š30ç§’ï¼ˆ3æ¬¡æœºä¼šï¼ŒæˆåŠŸå³è¿”å›ï¼‰

å¦‚æœç¬¬1æ¬¡æˆåŠŸ: è€—æ—¶çº¦5-10ç§’
å¦‚æœç¬¬2æ¬¡æˆåŠŸ: è€—æ—¶çº¦11-20ç§’
å¦‚æœç¬¬3æ¬¡æˆåŠŸ: è€—æ—¶çº¦21-30ç§’
```

---

### 2. è¿è¡Œæ—¶è‡ªåŠ¨é‡è¿æœºåˆ¶

**[GoldSky_Lite.ino:110-139](../GoldSky_Lite.ino#L110-L139)**

```cpp
void checkWiFi() {
  if (millis() - lastWiFiCheck > 30000) {  // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    bool wasConnected = sysStatus.wifiConnected;
    sysStatus.wifiConnected = (WiFi.status() == WL_CONNECTED);

    // å¦‚æœä¹‹å‰è¿æ¥æ­£å¸¸ä½†ç°åœ¨æ–­å¼€äº†ï¼Œå°è¯•é‡è¿
    if (wasConnected && !sysStatus.wifiConnected) {
      logWarn("âš ï¸ WiFiæ–­å¼€ï¼Œå°è¯•é‡è¿...");
      WiFi.disconnect();
      delay(500);
      WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

      // ç­‰å¾…3ç§’å°è¯•é‡è¿
      unsigned long startTime = millis();
      while (WiFi.status() != WL_CONNECTED && millis() - startTime < 3000) {
        delay(500);
      }

      if (WiFi.status() == WL_CONNECTED) {
        sysStatus.wifiConnected = true;
        logInfo("âœ… WiFié‡è¿æˆåŠŸ: " + WiFi.localIP().toString());
      } else {
        sysStatus.wifiConnected = false;
        logWarn("âš ï¸ WiFié‡è¿å¤±è´¥ï¼Œç»§ç»­ç¦»çº¿æ¨¡å¼");
      }
    }

    lastWiFiCheck = millis();
  }
}
```

**æ”¹è¿›è¦ç‚¹**ï¼š
- âœ… æ¯30ç§’è‡ªåŠ¨æ£€æŸ¥WiFiçŠ¶æ€
- âœ… æ£€æµ‹åˆ°æ–­å¼€åè‡ªåŠ¨é‡è¿ï¼ˆ3ç§’å°è¯•ï¼‰
- âœ… é‡è¿æˆåŠŸåæ¢å¤åœ¨çº¿åŠŸèƒ½
- âœ… é‡è¿å¤±è´¥ç»§ç»­ç¦»çº¿æ¨¡å¼

**è¿è¡Œæ—¶é‡è¿æµç¨‹**ï¼š
```
æ­£å¸¸è¿è¡Œ â†’ WiFiæ–­å¼€æ£€æµ‹ â†’ å°è¯•é‡è¿(3ç§’)
                              â”œâ”€ æˆåŠŸ â†’ æ¢å¤åœ¨çº¿åŠŸèƒ½
                              â””â”€ å¤±è´¥ â†’ ç»§ç»­ç¦»çº¿æ¨¡å¼(30ç§’åå†æ¬¡å°è¯•)
```

---

## ğŸ“Š æ”¹è¿›å‰åå¯¹æ¯”

### æ”¹è¿›å‰

```
å¯åŠ¨æµç¨‹:
1. WiFi.begin() â”€â”€â”€â”€â”
                    â”‚
2. ç­‰å¾…20ç§’ â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚
3. æ£€æŸ¥çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€ æˆåŠŸ â†’ âœ… åœ¨çº¿æ¨¡å¼
   â”‚
   â””â”€ å¤±è´¥ â†’ âŒ ç¦»çº¿æ¨¡å¼ï¼ˆä¸å†å°è¯•ï¼‰

è¿è¡Œæ—¶:
æ¯30ç§’æ£€æŸ¥çŠ¶æ€ï¼Œä½†ä¸å°è¯•é‡è¿
```

### æ”¹è¿›å

```
å¯åŠ¨æµç¨‹ï¼ˆæœ€å¤š3æ¬¡ï¼Œæ¯æ¬¡10ç§’ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬1æ¬¡å°è¯• (10ç§’è¶…æ—¶)        â”‚
â”‚  WiFi.begin()               â”‚
â”‚  ç­‰å¾…è¿æ¥...                â”‚
â”‚     â”œâ”€ æˆåŠŸ â†’ âœ… é€€å‡º        â”‚
â”‚     â””â”€ å¤±è´¥ â†’ ç»§ç»­           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬2æ¬¡å°è¯• (10ç§’è¶…æ—¶)        â”‚
â”‚  WiFi.disconnect()          â”‚
â”‚  delay(1000)                â”‚
â”‚  WiFi.begin()               â”‚
â”‚  ç­‰å¾…è¿æ¥...                â”‚
â”‚     â”œâ”€ æˆåŠŸ â†’ âœ… é€€å‡º        â”‚
â”‚     â””â”€ å¤±è´¥ â†’ ç»§ç»­           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬3æ¬¡å°è¯• (10ç§’è¶…æ—¶)        â”‚
â”‚  WiFi.disconnect()          â”‚
â”‚  delay(1000)                â”‚
â”‚  WiFi.begin()               â”‚
â”‚  ç­‰å¾…è¿æ¥...                â”‚
â”‚     â”œâ”€ æˆåŠŸ â†’ âœ… é€€å‡º        â”‚
â”‚     â””â”€ å¤±è´¥ â†’ âŒ ç¦»çº¿æ¨¡å¼    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿è¡Œæ—¶è‡ªåŠ¨é‡è¿:
æ¯30ç§’æ£€æŸ¥ â†’ æ–­å¼€æ£€æµ‹ â†’ è‡ªåŠ¨é‡è¿(3ç§’)
                          â”œâ”€ æˆåŠŸ â†’ âœ… æ¢å¤åœ¨çº¿
                          â””â”€ å¤±è´¥ â†’ ç»§ç»­ç¦»çº¿(ä¸‹æ¬¡å†è¯•)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### é¢„æœŸçš„ä¸²å£æ—¥å¿—

**æˆåŠŸæ¡ˆä¾‹ï¼ˆç¬¬ä¸€æ¬¡è¿æ¥æˆåŠŸï¼Œçº¦5-10ç§’ï¼‰**ï¼š
```
[INFO] è¿æ¥WiFi: hanzg_hanyh
.........
[INFO] âœ… WiFiè¿æ¥æˆåŠŸ: 192.168.1.100
```

**é‡è¯•æˆåŠŸæ¡ˆä¾‹ï¼ˆç¬¬äºŒæ¬¡æˆåŠŸï¼Œçº¦11-20ç§’ï¼‰**ï¼š
```
[INFO] è¿æ¥WiFi: hanzg_hanyh
....................
[WARN] âš ï¸ WiFié‡è¿å°è¯• 1/3
.........
[INFO] âœ… WiFiè¿æ¥æˆåŠŸ: 192.168.1.100 (é‡è¯•æˆåŠŸ)
```

**å¤±è´¥æ¡ˆä¾‹ï¼ˆ3æ¬¡éƒ½å¤±è´¥ï¼Œçº¦30ç§’ï¼‰**ï¼š
```
[INFO] è¿æ¥WiFi: hanzg_hanyh
....................
[WARN] âš ï¸ WiFié‡è¿å°è¯• 1/3
....................
[WARN] âš ï¸ WiFié‡è¿å°è¯• 2/3
....................
[WARN] âš ï¸ WiFiè¿æ¥å¤±è´¥ï¼ˆ3æ¬¡é‡è¯•åï¼‰ï¼Œè¿›å…¥ç¦»çº¿æ¨¡å¼
```

**è¿è¡Œæ—¶é‡è¿æ¡ˆä¾‹**ï¼š
```
[WARN] âš ï¸ WiFiæ–­å¼€ï¼Œå°è¯•é‡è¿...
......
[INFO] âœ… WiFié‡è¿æˆåŠŸ: 192.168.1.100
```

---

## âš™ï¸ å‚æ•°è°ƒæ•´ï¼ˆå¯é€‰ï¼‰

### é‡è¯•æ¬¡æ•°

```cpp
// GoldSky_Lite.ino:78
for (int retry = 0; retry < 3; retry++) {  // æ”¹ä¸º5æ¬¡é‡è¯•
```

### æ¯æ¬¡å°è¯•è¶…æ—¶æ—¶é—´

```cpp
// GoldSky_Lite.ino:89
while (WiFi.status() != WL_CONNECTED && millis() - startTime < 10000) {
// æ”¹ä¸º15ç§’: < 15000
```

### è¿è¡Œæ—¶é‡è¿è¶…æ—¶

```cpp
// GoldSky_Lite.ino:124
while (WiFi.status() != WL_CONNECTED && millis() - startTime < 3000) {
// æ”¹ä¸º5ç§’: < 5000
```

### æ£€æŸ¥é¢‘ç‡

```cpp
// GoldSky_Lite.ino:111
if (millis() - lastWiFiCheck > 30000) {  // æ¯30ç§’
// æ”¹ä¸ºæ¯60ç§’: > 60000
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¦‚æœ3æ¬¡é‡è¯•åä»å¤±è´¥

**æ£€æŸ¥WiFiè®¾ç½®**ï¼š
```cpp
// config.h
#define WIFI_SSID "hanzg_hanyh"        // æ£€æŸ¥SSIDæ˜¯å¦æ­£ç¡®
#define WIFI_PASSWORD "han1314521"     // æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®
```

**æ£€æŸ¥è·¯ç”±å™¨**ï¼š
1. è·¯ç”±å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
2. SSIDæ˜¯å¦éšè—ï¼ˆESP32ä¸æ”¯æŒéšè—SSIDè¿æ¥ï¼‰
3. WiFié¢‘æ®µæ˜¯å¦ä¸º2.4GHzï¼ˆESP32ä¸æ”¯æŒ5GHzï¼‰
4. MACåœ°å€è¿‡æ»¤æ˜¯å¦å¯ç”¨

**æ£€æŸ¥ESP32**ï¼š
```cpp
// ä¸´æ—¶è°ƒè¯•ï¼šå¢åŠ è¯¦ç»†æ—¥å¿—
WiFi.printDiag(Serial);  // æ‰“å°WiFiè¯Šæ–­ä¿¡æ¯
Serial.println("WiFi Status: " + String(WiFi.status()));
Serial.println("RSSI: " + String(WiFi.RSSI()));
```

### å¦‚æœè¿æ¥æˆåŠŸä½†ç»å¸¸æ–­å¼€

**å¢åŠ é‡è¿è¶…æ—¶**ï¼š
```cpp
// ä»3ç§’æ”¹ä¸º5ç§’
while (WiFi.status() != WL_CONNECTED && millis() - startTime < 5000) {
```

**æ£€æŸ¥ä¿¡å·å¼ºåº¦**ï¼š
```cpp
if (WiFi.RSSI() < -80) {
  logWarn("âš ï¸ WiFiä¿¡å·å¼±: " + String(WiFi.RSSI()) + " dBm");
}
```

---

## ğŸ’¡ WiFiçŠ¶æ€ç å«ä¹‰

```cpp
WiFi.status() è¿”å›å€¼:
WL_IDLE_STATUS     = 0  // ç©ºé—²
WL_NO_SSID_AVAIL   = 1  // æœªæ‰¾åˆ°SSID
WL_SCAN_COMPLETED  = 2  // æ‰«æå®Œæˆ
WL_CONNECTED       = 3  // å·²è¿æ¥ âœ…
WL_CONNECT_FAILED  = 4  // è¿æ¥å¤±è´¥
WL_CONNECTION_LOST = 5  // è¿æ¥ä¸¢å¤±
WL_DISCONNECTED    = 6  // æœªè¿æ¥
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¯åŠ¨æ—¶é—´ä¼˜åŒ–

**ç¬¬ä¸€æ¬¡å°±æˆåŠŸ**ï¼š
- åŸæ–¹æ¡ˆï¼š5-10ç§’
- æ–°æ–¹æ¡ˆï¼š5-10ç§’
- **æ— å·®å¼‚**

**ç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œç¬¬äºŒæ¬¡æˆåŠŸ**ï¼š
- åŸæ–¹æ¡ˆï¼š20ç§’ï¼ˆå¤±è´¥å°±æ”¾å¼ƒï¼‰
- æ–°æ–¹æ¡ˆï¼š11-20ç§’ï¼ˆé‡è¯•æˆåŠŸï¼‰
- **æå‡ï¼šèŠ‚çœ0-9ç§’**

**å…¨éƒ¨å¤±è´¥**ï¼š
- åŸæ–¹æ¡ˆï¼š20ç§’
- æ–°æ–¹æ¡ˆï¼š30ç§’
- **å»¶é•¿ï¼š10ç§’ï¼ˆä½†ç³»ç»Ÿå¯ä»¥å·¥ä½œåœ¨ç¦»çº¿æ¨¡å¼ï¼‰**

### è¿è¡Œæ—¶å¯é æ€§æå‡

- âœ… è‡ªåŠ¨æ£€æµ‹æ–­å¼€
- âœ… è‡ªåŠ¨é‡è¿
- âœ… æ— éœ€äººå·¥å¹²é¢„
- âœ… åœ¨çº¿/ç¦»çº¿æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [config.h](../config.h) - WiFié…ç½®
- [GoldSky_Lite.ino](../GoldSky_Lite.ino) - WiFiåˆå§‹åŒ–å’Œç®¡ç†
- [NFC_INIT_IMPROVEMENT.md](NFC_INIT_IMPROVEMENT.md) - NFCç±»ä¼¼æ”¹è¿›

---

## ğŸ¯ æ€»ç»“

### æ”¹è¿›å†…å®¹

1. âœ… **å¯åŠ¨é‡è¯•** - æœ€å¤š3æ¬¡é‡è¯•ï¼ˆæ¯æ¬¡10ç§’ï¼‰ï¼Œæé«˜è¿æ¥æˆåŠŸç‡
2. âœ… **å¿«é€Ÿå¤±è´¥** - æ¯æ¬¡å°è¯•ä»20ç§’ç¼©çŸ­åˆ°10ç§’ï¼ŒåŠ å¿«å¤±è´¥æ£€æµ‹
3. âœ… **è¿è¡Œæ—¶é‡è¿** - æ¯30ç§’æ£€æŸ¥ï¼Œæ–­å¼€åè‡ªåŠ¨é‡è¿
4. âœ… **è¯¦ç»†æ—¥å¿—** - æ˜¾ç¤ºé‡è¯•æ¬¡æ•°å’Œé‡è¿çŠ¶æ€

### ç”¨æˆ·ä½“éªŒæå‡

- âŒ æ”¹è¿›å‰ï¼šç¬¬ä¸€æ¬¡å¤±è´¥å°±æ”¾å¼ƒï¼ˆ20ç§’æµªè´¹ï¼‰
- âœ… æ”¹è¿›åï¼šè‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œæé«˜æˆåŠŸç‡
- âœ… è¿è¡Œæ—¶æ–­å¼€è‡ªåŠ¨é‡è¿ï¼Œæ— éœ€äººå·¥å¹²é¢„

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-02
**é€‚ç”¨ç‰ˆæœ¬**: GoldSky_Lite v2.4+
