# Nayax Pulse/ccTalk 配置分析 - GoldSky_Lite适配

分析日期：2025-11-02
参考系统：Nayax支付终端

---

## 🎯 配置对比总览

| 参数类别 | Nayax标准 | GoldSky_Lite原配置 | GoldSky_Lite新配置 | 状态 |
|---------|----------|------------------|------------------|------|
| **脉冲宽度** | 500ms | 100ms ❌ | 500ms ✅ | ✅ 已修正 |
| **脉冲周期** | 1000ms | 1000ms ✅ | 1000ms ✅ | ✅ 正确 |
| **套餐数量** | 4个 | 4个（+VIP） | 4个（+VIP） | ✅ 匹配 |
| **脉冲数** | 4,5,8,15 | 4,8,9,12 ❌ | 4,5,8,15 ✅ | ✅ 已修正 |
| **价格** | $4,$5,$8,$15 | $4,$6,$9,$12 ❌ | $4,$5,$8,$15 ✅ | ✅ 已修正 |

---

## 📊 详细参数分析

### 1. 脉冲时序参数

#### Nayax配置

```
Pulse active time:   50 × 10ms = 500ms   (高电平持续时间)
Pulse inactive time: 50 × 10ms = 500ms   (低电平持续时间)
总周期: 500ms + 500ms = 1000ms (1秒)
```

**时序图**：
```
       500ms      500ms
      ┌─────┐            ┌─────┐
HIGH  │     │            │     │
      │     │            │     │
LOW   ┘     └────────────┘     └────
      │◄───────1000ms────►│
      │   (PULSE_INTERVAL_MS)
```

#### GoldSky_Lite配置

**修改前** ❌：
```cpp
#define PULSE_WIDTH_MS 100        // 太短！
#define PULSE_INTERVAL_MS 1000
// 问题: 高电平只有100ms，低电平900ms，占空比10%
```

**修改后** ✅：
```cpp
#define PULSE_WIDTH_MS 500        // 匹配Nayax
#define PULSE_INTERVAL_MS 1000    // 匹配Nayax
// 正确: 高电平500ms，低电平500ms，占空比50%
```

**关键发现**：
- Nayax使用 **50%占空比** 的脉冲信号
- 我们原来的10%占空比可能导致洗车设备无法正确识别脉冲
- **500ms高电平** 是行业标准，确保可靠触发

---

### 2. 套餐配置对比

#### Nayax套餐设置

从截图中提取的配置：

| 套餐 | 时长 | 脉冲数 | 价格 | 标题 |
|------|------|--------|------|------|
| 1 | 4分钟 | 4 | $4.00 | "4 Min" |
| 2 | 5分钟 | 5 | $5.00 | "5 Min" |
| 3 | 8分钟 | 8 | $8.00 | "8 Min" |
| 4 | 15分钟 | 15 | $15.00 | "15 Min" |

**关键特征**：
- **时长 = 脉冲数**（每个脉冲代表1分钟洗车时间）
- **价格 = 脉冲数 × $1.00**（简单的线性定价）
- **标题格式**："X Min" 直接显示时长

#### GoldSky_Lite套餐配置

**修改前** ❌：
```cpp
static Package PACKAGES[] = {
  {"Quick Wash", "快速洗车", 4, 4.00, 4, false},    // ✅ 匹配
  {"Standard", "标准洗车", 6, 6.00, 8, false},      // ❌ 脉冲数错误
  {"Deluxe", "豪华洗车", 8, 9.00, 9, false},        // ❌ 脉冲数和价格错误
  {"Premium", "至尊洗车", 10, 12.00, 12, false},    // ❌ 脉冲数和价格错误
  {"VIP Info", "VIP查询", 0, 0.00, 0, true}
};
```

**问题分析**：
1. 套餐2: 6分钟但发送8个脉冲（设备会运行8分钟，不是6分钟）
2. 套餐3: 8分钟但发送9个脉冲（时长不匹配）
3. 套餐4: 10分钟但发送12个脉冲（时长不匹配）

**修改后** ✅：
```cpp
static Package PACKAGES[] = {
  {"4 Min Wash", "4分钟洗车", 4, 4.00, 4, false},     // Nayax套餐1
  {"5 Min Wash", "5分钟洗车", 5, 5.00, 5, false},     // Nayax套餐2
  {"8 Min Wash", "8分钟洗车", 8, 8.00, 8, false},     // Nayax套餐3
  {"15 Min Wash", "15分钟洗车", 15, 15.00, 15, false}, // Nayax套餐4
  {"VIP Info", "VIP查询", 0, 0.00, 0, true}
};
```

**修正要点**：
1. ✅ **时长 = 脉冲数**（每个脉冲=1分钟）
2. ✅ **标题明确显示时长**（"X Min Wash"）
3. ✅ **价格匹配Nayax标准**

---

### 3. 脉冲控制逻辑

#### 脉冲数 vs 实际运行时间

```
脉冲数  →  实际洗车时长
  4     →  4分钟
  5     →  5分钟
  8     →  8分钟
  15    →  15分钟
```

**重要**: 洗车设备根据 **接收到的脉冲数量** 来决定运行时长，不是根据终端显示的"minutes"字段！

#### 我们的实现 (GoldSky_PulseControl.ino)

```cpp
void sendPulses(int count) {
  for (int i = 0; i < count; i++) {
    // 高电平
    digitalWrite(PULSE_OUT, HIGH);
    delay(PULSE_WIDTH_MS);        // 500ms

    // 低电平
    digitalWrite(PULSE_OUT, LOW);

    if (i < count - 1) {
      delay(PULSE_INTERVAL_MS - PULSE_WIDTH_MS);  // 500ms
    }
  }
}
```

**时序验证**：
- 每个脉冲: 500ms HIGH + 500ms LOW = 1秒
- 4个脉冲总时长: 4秒
- 8个脉冲总时长: 8秒
- 15个脉冲总时长: 15秒

---

### 4. 其他Nayax参数（参考）

| 参数 | Nayax值 | 说明 | GoldSky_Lite相关 |
|------|---------|------|-----------------|
| **Inhibit Event Timeout** | 90秒 | 抑制事件超时 | 不适用（无抑制功能） |
| **Number of Increments** | 4 | 套餐数量 | PACKAGE_COUNT=5（含VIP） |
| **Pulse IN1 Counter** | 4 | 输入脉冲计数 | 不适用（仅输出脉冲） |
| **Pulse Inhibit** | 00 - Disabled | 抑制功能禁用 | 不适用 |
| **Welcome Message** | "Welcome" | 欢迎消息 | "EAGLSON WASH" |
| **Pulse Options** | 01 Use Price Array | 使用价格数组 | ✅ 使用PACKAGES数组 |

---

## ⚙️ 配置文件位置

### config.h (第57-60行)

```cpp
// =================== 脉冲和超时配置 ===================
// Nayax标准: active=500ms, inactive=500ms, 总周期=1000ms
#define PULSE_WIDTH_MS 500        // 脉冲高电平时间（匹配Nayax的50×10ms）
#define PULSE_INTERVAL_MS 1000    // 脉冲周期（高电平+低电平）
```

### config.h (第121-132行)

```cpp
// =================== 套餐配置 ===================
// 匹配Nayax配置: Pulse Increment = 4,5,8,15; Prices = $4,$5,$8,$15
#define PACKAGE_COUNT 5

static Package PACKAGES[PACKAGE_COUNT] = {
  {"4 Min Wash", "Lavage 4 min", "4分钟洗车", 4, 4.00, 4, false},
  {"5 Min Wash", "Lavage 5 min", "5分钟洗车", 5, 5.00, 5, false},
  {"8 Min Wash", "Lavage 8 min", "8分钟洗车", 8, 8.00, 8, false},
  {"15 Min Wash", "Lavage 15 min", "15分钟洗车", 15, 15.00, 15, false},
  {"VIP Info", "Info VIP", "VIP查询", 0, 0.00, 0, true}
};
```

---

## 🔬 技术分析

### 为什么500ms脉冲宽度很重要？

1. **可靠性** - 洗车设备的脉冲检测电路需要足够的时间来稳定识别信号
2. **抗干扰** - 500ms脉冲宽度可以有效过滤电气噪声和毛刺
3. **行业标准** - ccTalk/Pulse协议的通用规范
4. **机械继电器** - 一些老式设备使用继电器，需要较长的触发时间

### 占空比对比

```
原配置: 100ms / 1000ms = 10% 占空比
新配置: 500ms / 1000ms = 50% 占空比 (Nayax标准)
```

**10%占空比问题**：
- 脉冲过窄，可能被设备忽略
- 不符合ccTalk标准
- 与Nayax等商业系统不兼容

**50%占空比优势**：
- 易于检测和识别
- 符合行业标准
- 兼容性好

---

## 📈 套餐定价策略

### Nayax定价模式

```
时长(分钟)   脉冲数   价格     单价($/分钟)
    4          4      $4.00      $1.00
    5          5      $5.00      $1.00
    8          8      $8.00      $1.00
   15         15     $15.00      $1.00
```

**特点**：
- 线性定价，每分钟$1.00
- 简单透明，易于理解
- 无批量折扣

### 可选的定价策略（未来）

如果需要促销或会员优惠，可以考虑：

```cpp
// 会员折扣示例
static Package PACKAGES_VIP[] = {
  {"4 Min Wash", "4分钟洗车", 4, 3.50, 4, false},   // 12.5%折扣
  {"5 Min Wash", "5分钟洗车", 5, 4.25, 5, false},   // 15%折扣
  {"8 Min Wash", "8分钟洗车", 8, 6.80, 8, false},   // 15%折扣
  {"15 Min Wash", "15分钟洗车", 15, 12.75, 15, false}, // 15%折扣
};
```

**注意**: 脉冲数不变，只调整价格！

---

## 🧪 测试建议

### 1. 脉冲输出测试

使用示波器或逻辑分析仪测量GPIO 3（PULSE_OUT）：

```
测试项目：
□ 高电平时间 = 500ms ± 10ms
□ 低电平时间 = 500ms ± 10ms
□ 总周期 = 1000ms ± 20ms
□ 高电平电压 = 3.3V
□ 低电平电压 = 0V
```

### 2. 套餐功能测试

```
测试项目：
□ 选择"4 Min Wash"，设备运行4分钟
□ 选择"5 Min Wash"，设备运行5分钟
□ 选择"8 Min Wash"，设备运行8分钟
□ 选择"15 Min Wash"，设备运行15分钟
□ 扣款金额与套餐价格一致
```

### 3. 串口监控

测试时打开串口监视器（115200波特率），观察：

```
期望输出:
"发送脉冲: 1/4"
"发送脉冲: 2/4"
"发送脉冲: 3/4"
"发送脉冲: 4/4"
"脉冲发送完成"
```

---

## ⚠️ 重要注意事项

### 1. 不要随意修改脉冲数

```cpp
// ❌ 错误: 时长和脉冲数不匹配
{"5 Min Wash", "5分钟洗车", 5, 5.00, 8, false}
//  显示5分钟 ↑               实际8分钟 ↑

// ✅ 正确: 时长和脉冲数一致
{"5 Min Wash", "5分钟洗车", 5, 5.00, 5, false}
//  显示5分钟 ↑               实际5分钟 ↑
```

### 2. 价格可以灵活调整

脉冲数决定运行时长，价格可以根据商业策略调整：

```cpp
// 促销价格示例（脉冲数不变）
{"5 Min Wash", "5分钟洗车", 5, 3.99, 5, false}  // 促销价$3.99
```

### 3. 超时时间考虑

15分钟套餐需要调整处理超时：

```cpp
// 原配置
#define STATE_TIMEOUT_PROCESSING_MS 120000  // 2分钟 ❌ 太短！

// 建议修改
#define STATE_TIMEOUT_PROCESSING_MS 960000  // 16分钟 (15分钟+1分钟缓冲)
```

---

## 📋 修改清单

### ✅ 已完成

- [x] 修改 PULSE_WIDTH_MS: 100ms → 500ms
- [x] 更新套餐1: 保持4分钟/4脉冲/$4
- [x] 更新套餐2: 6分钟/8脉冲 → 5分钟/5脉冲/$5
- [x] 更新套餐3: 8分钟/9脉冲 → 8分钟/8脉冲/$8
- [x] 更新套餐4: 10分钟/12脉冲 → 15分钟/15脉冲/$15
- [x] 更新套餐标题: 使用"X Min Wash"格式

### 🔜 建议修改（可选）

- [ ] 增加 STATE_TIMEOUT_PROCESSING_MS 到 960000ms（16分钟）
- [ ] 在displayWashProgress()中显示剩余脉冲数（更直观）
- [ ] 添加脉冲发送速率监控（确保1秒/脉冲）
- [ ] 实现VIP会员价格表（如需要）

---

## 🔗 相关文档

- [config.h](../config.h) - 主配置文件
- [GoldSky_PulseControl.ino](../GoldSky_PulseControl.ino) - 脉冲控制实现
- [FONT_BEST_PRACTICES.md](FONT_BEST_PRACTICES.md) - 显示优化文档

---

## 📞 技术支持

如果洗车设备无法正常响应脉冲，请检查：

1. **电气连接**：PULSE_OUT (GPIO 3) 是否正确连接到设备输入
2. **电压兼容**：设备是否接受3.3V逻辑电平（可能需要5V转换）
3. **脉冲极性**：设备是否需要低电平触发（可能需要反相）
4. **测量验证**：使用万用表/示波器确认脉冲输出

---

**文档版本**: v1.0
**最后更新**: 2025-11-02
**作者**: Claude (基于Nayax配置截图分析)
